{
  "$id": "schema/step_attempt.v1.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "StepAttempt v1",
  "description": "Single invocation of a tool (Aider, Codex, Claude, etc.) within a run.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "step_attempt_id",
    "run_id",
    "sequence",
    "tool_id",
    "state",
    "started_at"
  ],
  "properties": {
    "step_attempt_id": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Unique identifier for this step attempt (ULID)"
    },
    "run_id": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Run this step belongs to"
    },
    "sequence": {
      "type": "integer",
      "minimum": 1,
      "description": "Sequence number within the run (1-indexed)"
    },
    "tool_id": {
      "type": "string",
      "minLength": 1,
      "description": "Identifier of the tool being invoked"
    },
    "tool_run_id": {
      "type": ["string", "null"],
      "description": "Tool-specific run identifier if available"
    },
    "execution_request_id": {
      "type": ["string", "null"],
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Optional execution request this step fulfills"
    },
    "prompt_id": {
      "type": ["string", "null"],
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Optional prompt instance used for this step"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "When this step started execution"
    },
    "ended_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "When this step completed or failed"
    },
    "state": {
      "type": "string",
      "enum": [
        "pending",
        "running",
        "completed",
        "error",
        "canceled"
      ],
      "description": "Current state of this step"
    },
    "state_reason": {
      "type": ["string", "null"],
      "description": "Human-readable reason for current state"
    },
    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "description": "Outputs produced by this step",
      "properties": {
        "patch_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
          },
          "uniqueItems": true,
          "description": "Patch artifacts produced by this step"
        },
        "logs_path": {
          "type": ["string", "null"],
          "description": "Path to execution logs"
        },
        "raw_response_path": {
          "type": ["string", "null"],
          "description": "Path to raw tool response"
        }
      }
    }
  }
}
