{
  "$id": "schema/patch_ledger_entry.v1.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PatchLedgerEntry v1",
  "description": "Audit trail and lifecycle record for a patch. Tracks validation, application, and quarantine states.",
  "type": "object",
  "additionalProperties": false,
  "required": ["ledger_id", "patch_id", "project_id", "state", "validation"],
  "properties": {
    "ledger_id": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Unique identifier for this ledger entry (ULID)"
    },
    "patch_id": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Patch this entry tracks"
    },
    "project_id": {
      "type": "string",
      "minLength": 1,
      "description": "Project this patch belongs to"
    },
    "phase_id": {
      "type": ["string", "null"],
      "description": "Phase this patch was created in"
    },
    "workstream_id": {
      "type": ["string", "null"],
      "description": "Workstream this patch belongs to"
    },
    "execution_request_id": {
      "type": ["string", "null"],
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Execution request that produced this patch"
    },
    "state": {
      "type": "string",
      "enum": [
        "created",
        "validated",
        "queued",
        "applied",
        "apply_failed",
        "verified",
        "committed",
        "rolled_back",
        "quarantined",
        "dropped"
      ],
      "description": "Current state of this patch"
    },
    "state_history": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["state", "at"],
        "properties": {
          "state": {
            "type": "string",
            "description": "State the patch transitioned to"
          },
          "at": {
            "type": "string",
            "format": "date-time",
            "description": "When the transition occurred"
          },
          "reason": {
            "type": "string",
            "description": "Why the transition occurred"
          }
        }
      },
      "description": "History of state transitions"
    },
    "validation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["format_ok", "scope_ok", "constraints_ok"],
      "description": "Validation results",
      "properties": {
        "format_ok": {
          "type": "boolean",
          "description": "Whether patch format is valid"
        },
        "scope_ok": {
          "type": "boolean",
          "description": "Whether patch scope is within allowed boundaries"
        },
        "constraints_ok": {
          "type": "boolean",
          "description": "Whether patch meets policy constraints"
        },
        "tests_ran": {
          "type": "boolean",
          "description": "Whether tests were executed"
        },
        "tests_passed": {
          "type": "boolean",
          "description": "Whether tests passed"
        },
        "validation_errors": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of validation errors encountered"
        }
      }
    },
    "apply": {
      "type": "object",
      "additionalProperties": false,
      "description": "Application attempt information",
      "properties": {
        "attempts": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of application attempts"
        },
        "last_attempt_at": {
          "type": "string",
          "format": "date-time",
          "description": "When the last attempt was made"
        },
        "last_error_code": {
          "type": "string",
          "description": "Error code from last failed attempt"
        },
        "last_error_message": {
          "type": "string",
          "description": "Error message from last failed attempt"
        },
        "workspace_path": {
          "type": "string",
          "description": "Path to workspace where patch was applied"
        },
        "applied_files": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true,
          "description": "Files that were successfully modified"
        }
      }
    },
    "quarantine": {
      "type": "object",
      "additionalProperties": false,
      "description": "Quarantine information if patch was quarantined",
      "properties": {
        "is_quarantined": {
          "type": "boolean",
          "description": "Whether patch is currently quarantined"
        },
        "quarantine_reason": {
          "type": "string",
          "description": "Why the patch was quarantined"
        },
        "quarantine_path": {
          "type": "string",
          "description": "Path where quarantined patch is stored"
        },
        "quarantined_at": {
          "type": "string",
          "format": "date-time",
          "description": "When the patch was quarantined"
        }
      }
    },
    "relations": {
      "type": "object",
      "additionalProperties": false,
      "description": "Relationships to other patches",
      "properties": {
        "replaces_patch_id": {
          "type": ["string", "null"],
          "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
          "description": "Patch this one replaces"
        },
        "rollback_of_patch_id": {
          "type": ["string", "null"],
          "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
          "description": "Patch this one rolls back"
        },
        "chain_id": {
          "type": ["string", "null"],
          "description": "Chain ID for related patches"
        }
      }
    }
  }
}
