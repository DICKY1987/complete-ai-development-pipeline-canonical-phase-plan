[
  {
    "op": "add",
    "path": "/meta/patch_metadata",
    "value": {
      "patch_id": "006-schema-definitions",
      "patch_ulid": "01JDKCXWQP8PATCH006SCHEMA01",
      "created_at": "2025-11-23T11:40:15.088Z",
      "description": "Integrate JSON Schema definitions from schema/ directory (18 schema files defining core data contracts)",
      "source_files": [
        "schema/run_record.v1.json",
        "schema/step_attempt.v1.json",
        "schema/patch_ledger_entry.v1.json",
        "schema/execution_request.v1.json",
        "schema/workstream_spec.v1.json",
        "schema/task_spec.v1.json",
        "schema/router_config.v1.json",
        "schema/project_profile.v1.json"
      ],
      "operations_count": 17,
      "priority": "CRITICAL",
      "approved_by": "human",
      "applied": false
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_registry",
    "value": {
      "location": "schema/",
      "total_schemas": 18,
      "schema_version": "draft-07",
      "documented_schemas": 8,
      "ulid_pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "schema_categories": {
        "core_lifecycle": ["run_record.v1.json", "step_attempt.v1.json", "run_event.v1.json"],
        "patch_management": ["patch_artifact.v1.json", "patch_ledger_entry.v1.json", "patch_policy.v1.json"],
        "execution": ["execution_request.v1.json", "task_spec.v1.json", "workstream_spec.v1.json"],
        "configuration": ["router_config.v1.json", "project_profile.v1.json", "profile_extension.v1.json"],
        "prompts": ["prompt_instance.v1.json"],
        "bootstrap": ["bootstrap_discovery.v1.json", "bootstrap_report.v1.json"],
        "documentation": ["doc-meta.v1.json", "phase_spec.v1.json"]
      }
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/run_record",
    "value": {
      "schema_id": "schema/run_record.v1.json",
      "title": "RunRecord v1",
      "description": "Top-level execution record for a phase/workstream",
      "required_fields": ["run_id", "project_id", "phase_id", "state", "created_at"],
      "state_enum": ["pending", "running", "succeeded", "failed", "canceled", "quarantined"],
      "key_properties": {
        "run_id": "ULID identifier",
        "state": "Current lifecycle state",
        "origin": "Trigger information (trigger_type: manual|ci|error_pipeline|scheduled|other)",
        "counters": "Aggregate metrics (step_attempts, patches_created, patches_applied, errors)"
      },
      "timestamps": ["created_at", "started_at", "ended_at"],
      "relationships": ["project_id", "phase_id", "workstream_id", "execution_request_id"],
      "alignment_with_code": "Matches core/engine/orchestrator.py implementation"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/step_attempt",
    "value": {
      "schema_id": "schema/step_attempt.v1.json",
      "title": "StepAttempt v1",
      "description": "Single invocation of a tool within a run",
      "required_fields": ["step_attempt_id", "run_id", "sequence", "tool_id", "state", "started_at"],
      "state_enum": ["pending", "running", "completed", "error", "canceled"],
      "key_properties": {
        "step_attempt_id": "ULID identifier",
        "sequence": "Step number within run (1-indexed)",
        "tool_id": "Identifier of tool being invoked",
        "outputs": "Patch IDs, logs path, raw response path"
      },
      "timestamps": ["started_at", "ended_at"],
      "relationships": ["run_id", "execution_request_id", "prompt_id"],
      "alignment_with_code": "Matches core/engine/orchestrator.py step management"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/patch_ledger_entry",
    "value": {
      "schema_id": "schema/patch_ledger_entry.v1.json",
      "title": "PatchLedgerEntry v1",
      "description": "Audit trail and lifecycle record for a patch",
      "required_fields": ["ledger_id", "patch_id", "project_id", "state", "validation"],
      "state_enum": ["created", "validated", "queued", "applied", "apply_failed", "verified", "committed", "rolled_back", "quarantined", "dropped"],
      "state_machine": {
        "description": "10-state patch lifecycle",
        "terminal_states": ["committed", "rolled_back", "quarantined", "dropped"],
        "validation_points": ["created → validated", "validated → queued", "applied → verified"]
      },
      "key_properties": {
        "validation": "format_ok, scope_ok, constraints_ok, tests_ran, tests_passed",
        "apply": "Application attempts, errors, workspace path, applied files",
        "quarantine": "Quarantine status, reason, path, timestamp",
        "relations": "replaces_patch_id, rollback_of_patch_id, chain_id"
      },
      "state_history": "Array of state transitions with timestamps and reasons",
      "alignment_with_spec": "Matches docs/uet_v2/STATE_MACHINES.md#patch-ledger-state-machine"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/execution_request",
    "value": {
      "schema_id": "schema/execution_request.v1.json",
      "title": "ExecutionRequest v1",
      "description": "Unit of work to be routed to a tool",
      "required_fields": ["request_id", "project_id", "phase_id", "task_kind", "classification", "resource_scope", "routing"],
      "key_properties": {
        "classification": "complexity (trivial|simple|moderate|complex|expert), risk_tier, domain, priority",
        "resource_scope": "read, write, create, forbidden file arrays",
        "constraints": "patch_only, tests_must_pass, max_lines_changed",
        "routing": "strategy (fixed|round_robin|auto), allowed_tools, max_attempts, timeout"
      },
      "task_kinds": "code_edit, code_review, analysis, etc.",
      "relationships": ["project_id", "phase_id", "workstream_id", "prompt_spec"],
      "alignment_with_code": "Matches core/engine/execution_request_builder.py"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/workstream_spec",
    "value": {
      "schema_id": "schema/workstream_spec.v1.json",
      "title": "WorkstreamSpec v1",
      "description": "Workstream definition containing sequence of tasks",
      "required_fields": ["workstream_id", "project_id", "phase_id", "name", "objective", "tasks"],
      "key_properties": {
        "concurrency": "max_parallel tasks",
        "error_handling": "strategy (fail_fast|continue|escalate)",
        "acceptance": "mode (all|any|custom), checks array"
      },
      "tasks": "Array of TaskSpec v1 objects",
      "relationships": ["project_id", "phase_id"],
      "alignment_with_plan": "Matches master plan workstream structure"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/task_spec",
    "value": {
      "schema_id": "schema/task_spec.v1.json",
      "title": "TaskSpec v1",
      "description": "Individual task within a workstream",
      "required_fields": ["task_id", "name", "kind"],
      "key_properties": {
        "depends_on": "Array of task IDs (enables DAG)",
        "allow_parallel": "Boolean for parallel execution",
        "classification": "complexity, risk_tier, domain, priority",
        "execution": "max_attempts, timeout_seconds, retry_strategy, background",
        "prompt_template_ref": "Reference to prompt template",
        "execution_request_template": "Template for building ExecutionRequest"
      },
      "relationships": ["depends_on task IDs"],
      "alignment_with_code": "Matches core/engine/scheduler.py Task model"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/router_config",
    "value": {
      "schema_id": "schema/router_config.v1.json",
      "title": "RouterConfig v1",
      "description": "Configuration for task routing engine",
      "required_fields": ["version", "apps", "routing"],
      "key_properties": {
        "apps": "Object of tool configs (kind, command, capabilities, limits, safety_tier)",
        "routing.rules": "Array of routing rules (id, match, select_from, strategy, validate_with)",
        "defaults": "max_attempts, timeout_seconds, strategy"
      },
      "app_kinds": ["tool", "validator", "analyzer"],
      "routing_strategies": ["fixed", "round_robin", "auto"],
      "safety_tiers": ["low", "medium", "high"],
      "alignment_with_code": "Matches core/engine/router.py config structure"
    }
  },
  {
    "op": "add",
    "path": "/meta/schema_definitions/project_profile",
    "value": {
      "schema_id": "schema/project_profile.v1.json",
      "title": "ProjectProfile v1",
      "description": "Project-specific configuration from bootstrap",
      "required_fields": ["project_id", "project_name", "project_root", "domain", "profile_id", "resource_types", "available_tools", "framework_paths", "constraints"],
      "domain_enum": ["software-dev", "data-pipeline", "operations", "documentation", "mixed"],
      "key_properties": {
        "resource_types": "Configuration for resource types (root, tracked_by, exclusions)",
        "available_tools": "Detected tools (tool_id, command, capabilities, max_parallel)",
        "framework_paths": "tasks_dir, ledger_dir, worktrees_dir, quarantine_dir, registry_file",
        "constraints": "patch_only, tests_must_pass, ascii_only, max_lines_changed, max_files_changed"
      },
      "alignment_with_files": "Matches PROJECT_PROFILE.yaml structure"
    }
  },
  {
    "op": "add",
    "path": "/validation/schema_validation",
    "value": {
      "json_schema_version": "draft-07",
      "validation_tool": "ajv or jsonschema (Python)",
      "required_checks": {
        "ulid_format": "All IDs must match ULID pattern ^[0-9A-HJKMNP-TV-Z]{26}$",
        "enum_compliance": "State fields must use defined enums",
        "datetime_format": "Timestamps must be ISO 8601 / RFC 3339",
        "required_fields": "All required fields must be present"
      },
      "validation_gates": {
        "run_record_validation": {
          "command": "ajv validate -s schema/run_record.v1.json -d <data>",
          "required": true
        },
        "step_attempt_validation": {
          "command": "ajv validate -s schema/step_attempt.v1.json -d <data>",
          "required": true
        },
        "patch_ledger_validation": {
          "command": "ajv validate -s schema/patch_ledger_entry.v1.json -d <data>",
          "required": true
        }
      }
    }
  },
  {
    "op": "add",
    "path": "/phases/PH-000/workstreams/WS-000-009",
    "value": {
      "workstream_id": "WS-000-009",
      "workstream_ulid": "01JDKCXWQP8WS000009SCHEMA1",
      "name": "Schema Validation Infrastructure",
      "phase_id": "PH-000",
      "priority": "HIGH",
      "estimated_duration_hours": 2.0,
      "dependencies": [],
      "description": "Set up JSON Schema validation for all data contracts",
      "tasks": {
        "TSK-000-009-001": {
          "task_id": "TSK-000-009-001",
          "task_ulid": "01JDKCXWQP8TSK000009001AJV",
          "name": "Install JSON Schema validator",
          "workstream_id": "WS-000-009",
          "executor": "shell",
          "command": "pip install jsonschema",
          "file_scope": {
            "create": [],
            "modify": [],
            "read_only": ["requirements.txt"]
          },
          "acceptance_tests": {
            "powershell": "python -c \"import jsonschema; print(jsonschema.__version__)\"",
            "pytest": null
          },
          "max_runtime_seconds": 300,
          "idempotent": true
        },
        "TSK-000-009-002": {
          "task_id": "TSK-000-009-002",
          "task_ulid": "01JDKCXWQP8TSK000009002VAL",
          "name": "Create schema validation script",
          "workstream_id": "WS-000-009",
          "executor": "file_create",
          "inputs": {
            "file_path": {"type": "string", "default": "scripts/validate_schemas.py"}
          },
          "file_scope": {
            "create": ["scripts/validate_schemas.py"],
            "modify": [],
            "read_only": ["schema/*.json"]
          },
          "acceptance_tests": {
            "powershell": "python scripts/validate_schemas.py --help",
            "pytest": null
          },
          "max_runtime_seconds": 600,
          "idempotent": true,
          "dependencies": ["TSK-000-009-001"]
        },
        "TSK-000-009-003": {
          "task_id": "TSK-000-009-003",
          "task_ulid": "01JDKCXWQP8TSK000009003DOC",
          "name": "Document schema usage",
          "workstream_id": "WS-000-009",
          "executor": "file_create",
          "inputs": {
            "file_path": {"type": "string", "default": "docs/SCHEMA_GUIDE.md"}
          },
          "file_scope": {
            "create": ["docs/SCHEMA_GUIDE.md"],
            "modify": [],
            "read_only": ["schema/*.json"]
          },
          "acceptance_tests": {
            "powershell": "Test-Path docs/SCHEMA_GUIDE.md",
            "pytest": null
          },
          "max_runtime_seconds": 600,
          "idempotent": true,
          "dependencies": ["TSK-000-009-002"]
        }
      },
      "completion_criteria": {
        "all_tasks_complete": true,
        "validator_installed": true,
        "validation_script_exists": true,
        "documentation_exists": true
      }
    }
  },
  {
    "op": "replace",
    "path": "/phases/PH-000/estimated_duration_hours",
    "value": 9.0
  },
  {
    "op": "add",
    "path": "/meta/data_contracts",
    "value": {
      "description": "JSON Schema-based data contracts for all system entities",
      "enforcement": "Runtime validation with jsonschema library",
      "benefits": [
        "Type safety for JSON data",
        "Self-documenting API contracts",
        "Validation before database writes",
        "Cross-language compatibility",
        "IDE autocomplete support"
      ],
      "schema_alignment": {
        "run_record": "Matches orchestrator.py create_run/update_run",
        "step_attempt": "Matches orchestrator.py create_step_attempt",
        "patch_ledger_entry": "Defines patch lifecycle (10 states)",
        "execution_request": "Matches execution_request_builder.py",
        "task_spec": "Matches scheduler.py Task model",
        "router_config": "Matches router.py config structure",
        "workstream_spec": "Matches master plan workstream structure",
        "project_profile": "Matches PROJECT_PROFILE.yaml"
      }
    }
  },
  {
    "op": "add",
    "path": "/meta/ulid_specification",
    "value": {
      "description": "Universally Unique Lexicographically Sortable Identifier",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
      "length": 26,
      "encoding": "Crockford Base32",
      "properties": [
        "128-bit compatibility with UUID",
        "Lexicographically sortable",
        "Timestamp-based ordering",
        "URL-safe characters",
        "Case-insensitive"
      ],
      "used_in_schemas": [
        "run_record.run_id",
        "step_attempt.step_attempt_id",
        "patch_ledger_entry.ledger_id",
        "patch_ledger_entry.patch_id",
        "execution_request.request_id"
      ],
      "implementation_status": "Using UUID placeholder in orchestrator.py (needs real ULID library)"
    }
  },
  {
    "op": "add",
    "path": "/validation/quality_gates/schema_compliance",
    "value": {
      "run_record_schema": {
        "command": "python scripts/validate_schemas.py --schema run_record.v1.json --data <run_data>",
        "required": true,
        "description": "Validate run records against schema"
      },
      "step_attempt_schema": {
        "command": "python scripts/validate_schemas.py --schema step_attempt.v1.json --data <step_data>",
        "required": true,
        "description": "Validate step attempts against schema"
      },
      "patch_ledger_schema": {
        "command": "python scripts/validate_schemas.py --schema patch_ledger_entry.v1.json --data <patch_data>",
        "required": true,
        "description": "Validate patch ledger entries against schema"
      }
    }
  },
  {
    "op": "add",
    "path": "/meta/implementation_notes/schema_usage",
    "value": {
      "validation_pattern": "Validate objects before database insertion",
      "example_code": "from jsonschema import validate; validate(instance=data, schema=schema)",
      "error_handling": "Raise ValidationError with detailed field-level errors",
      "performance": "Schema compilation recommended for repeated validation",
      "integration_points": [
        "core/engine/orchestrator.py - Validate run/step records",
        "core/patches/patch_ledger.py - Validate ledger entries",
        "core/engine/router.py - Validate router config on load"
      ]
    }
  },
  {
    "op": "add",
    "path": "/phases/PH-001/workstreams/WS-001-004",
    "value": {
      "workstream_id": "WS-001-004",
      "workstream_ulid": "01JDKCXWQP8WS001004SCHEMAV",
      "name": "Integrate Schema Validation into Engine",
      "phase_id": "PH-001",
      "priority": "HIGH",
      "estimated_duration_hours": 3.0,
      "dependencies": ["WS-000-009"],
      "description": "Add runtime schema validation to orchestrator and patch manager",
      "tasks": {
        "TSK-001-004-001": {
          "task_id": "TSK-001-004-001",
          "task_ulid": "01JDKCXWQP8TSK001004001ORC",
          "name": "Add schema validation to orchestrator",
          "workstream_id": "WS-001-004",
          "executor": "code_edit",
          "file_scope": {
            "create": [],
            "modify": ["core/engine/orchestrator.py"],
            "read_only": ["schema/run_record.v1.json", "schema/step_attempt.v1.json"]
          },
          "acceptance_tests": {
            "powershell": null,
            "pytest": "pytest tests/engine/test_orchestrator_validation.py"
          },
          "max_runtime_seconds": 1800,
          "idempotent": false
        },
        "TSK-001-004-002": {
          "task_id": "TSK-001-004-002",
          "task_ulid": "01JDKCXWQP8TSK001004002PTH",
          "name": "Add schema validation to patch ledger",
          "workstream_id": "WS-001-004",
          "executor": "code_edit",
          "file_scope": {
            "create": [],
            "modify": ["core/patches/patch_ledger.py"],
            "read_only": ["schema/patch_ledger_entry.v1.json"]
          },
          "acceptance_tests": {
            "powershell": null,
            "pytest": "pytest tests/patches/test_patch_ledger_validation.py"
          },
          "max_runtime_seconds": 1800,
          "idempotent": false,
          "dependencies": ["TSK-001-004-001"]
        }
      },
      "completion_criteria": {
        "all_tasks_complete": true,
        "validation_integrated": true,
        "tests_passing": true
      }
    }
  },
  {
    "op": "replace",
    "path": "/phases/PH-001/estimated_duration_hours",
    "value": 5.0
  }
]
