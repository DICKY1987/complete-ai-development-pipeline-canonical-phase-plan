# Pattern: Atomic Create
# USE_CASE: Creating 1-3 files with tests in one execution turn
# TIME_SAVINGS: 60% (30 min -> 12 min)
# PROVEN_USES: 0 (initial version)

pattern_id: "atomic_create_v1"
category: "file_creation"

description: "Create 1-3 implementation files with complete test suites in a single atomic operation"
use_case: "Use when creating new modules, components, or features that require both implementation and tests"
time_savings: "60% (30 min -> 12 min)"

# Pre-made decisions (eliminates ~8 minutes of planning)
structural_decisions:
  max_files_per_phase: 3
  always_include_tests: true
  test_ratio: "1 test file per implementation file"
  no_placeholders: true
  include_docstrings: true
  include_type_hints: true
  min_test_count: 3

# Execution sequence (eliminates runtime decision-making)
execution_steps:
  1_verify_parent_dirs:
    checks:
      - "Parent directories exist for all target files"
      - "No conflicting files at target paths"
    on_fail: "create_parents_auto"
  
  2_create_files:
    strategy: "sequential"
    order:
      - "implementation_files"
      - "test_files"
    
    implementation_files:
      approach: "complete_file_in_one_turn"
      no_placeholders: true
      include_docstrings: true
      include_type_hints: true
      style: "black_formatted"
      
    test_files:
      approach: "complete_test_suite"
      min_test_count: 3
      test_types:
        - "happy_path"
        - "error_cases"
        - "edge_cases"
      framework: "pytest"
  
  3_verify_creation:
    checks:
      - cmd: "Test-Path ${file_path}"
        for_each: "created_files"
        expect: "True"
      
      - cmd: "python -m py_compile ${file_path}"
        for_each: "python_files"
        expect: "exit_code == 0"
  
  4_run_tests:
    cmd: "python -m pytest ${test_file} -v --tb=short"
    expect_pattern: ".*passed.*0 failed.*"
    on_fail: "enter_fix_loop"
  
  5_git_status:
    cmd: "git status --porcelain"
    expect_count: "${created_files.length}"
    expect_pattern: "^\\?\\?\\s+.*"

# Ground truth success criteria
ground_truth:
  success_criteria:
    - "All files exist at expected paths"
    - "All Python files compile without syntax errors"
    - "All tests pass on first run"
    - "Git status shows only expected new files"
    - "No placeholder comments (TODO, FIXME, ...)"
  
  failure_indicators:
    - "File creation failed"
    - "SyntaxError"
    - "Test failures"
    - "Unexpected files modified"

# Pre-authorized auto-fixes
pre_authorized_fixes:
  missing_parent_directory:
    detection: "FileNotFoundError.*No such file or directory"
    action: "New-Item -ItemType Directory -Path ${parent_path} -Force"
    verify: "Test-Path ${parent_path}"
    max_auto_attempts: 1
  
  syntax_error_indentation:
    detection: "IndentationError|TabError"
    action: "black ${file_path}"
    tool: "black"
    verify: "python -m py_compile ${file_path}"
    max_auto_attempts: 2

# Requires human intervention
requires_human_intervention:
  file_already_exists:
    detection: "File.*already exists"
    action: "stop_and_ask"
    reason: "May contain important code - manual review required"
  
  import_errors_after_creation:
    detection: "ModuleNotFoundError"
    action: "stop_and_report"
    reason: "Dependencies may need to be installed or configured"

# Operational guidance
operator_instructions:
  mindset: "operator_not_planner"
  
  execution_policy:
    - "Create complete files in one turn - no iterative development"
    - "Include all necessary imports, functions, and tests"
    - "Follow project code style automatically (black, type hints)"
    - "Verify programmatically - don't ask for confirmation"
  
  quality_gates:
    - "File must compile"
    - "Tests must pass"
    - "No placeholders"
    - "Scope validated"

# Example usage
example:
  context:
    files:
      - path: "src/error/detector.py"
        type: "implementation"
      - path: "tests/error/test_detector.py"
        type: "test_suite"
  
  expected_duration: "12 minutes"
  expected_outcome:
    - "2 files created"
    - "3+ tests passing"
    - "All checks green"

# Metadata
meta:
  created_at: "2025-11-23"
  version: "1.0.0"
  based_on: "17 manifests case study + atomic execution principles"
  proven_uses: 0
  target_speedup: "60%"
