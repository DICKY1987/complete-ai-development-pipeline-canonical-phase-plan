
---

````markdown
# COPILOT-DOCID-EXECUTION-GUIDE

**Status**: DRAFT  
**Audience**: GitHub Copilot CLI / AI coding assistants  
**Scope**: `complete-ai-development-pipeline-canonical-phase-plan` repository  
**Purpose**: Explain how to work with the DOC_ID system in a deterministic, safe way, correcting the inefficiencies from the first DOC_ID rollout.

---

## 1. What You Are Responsible For

You are GitHub Copilot operating inside this repo.

Your job when working on documentation, IDs, and related automation is to:

1. **Respect the naming and layout rules** for docs (`DOC_`, `PLAN_`, `_DEV_`).
2. **Use the provided tools** (`doc_triage.py`, `doc_id_registry_cli.py`) instead of editing registry/metadata by hand.
3. **Follow the phased, pattern-based execution model** below.
4. **Avoid the old anti-patterns**:
   - No direct concurrent edits to `DOC_ID_REGISTRY.yaml` from multiple worktrees.
   - No “rerun the same batch until it works” if a command crashes.
   - No manual, ad hoc rebuilding of indexes.

---

## 2. Core Concepts & Naming

### 2.1 Document Classes

You must treat Markdown docs as belonging to one of these classes:

- `DOC_*` – **Canonical documentation** (governed, must have `doc_id`)
- `PLAN_*` – **Future executable plans** (may become canonical)
- `_DEV_*` – **Scratch / development notes** (never get `doc_id`)

**File locations:**

- `docs/**/DOC_*.md` – Global canonical docs  
- `workstreams/plans/**/PLAN_*.md` – Plan docs  
- `modules/**/DOC_*.md` – Module-local canonical docs  
- `developer/**/_DEV_*.md|.txt` – Scratch / temp dev docs

### 2.2 ID Eligibility

A Markdown file is **ID-eligible** *only if*:

1. It lives in **one of**:
   - `docs/**/DOC_*.md`
   - `workstreams/plans/**/PLAN_*.md`
   - `modules/**/DOC_*.md`
2. Its name does **not** start with `_DEV_` or `_`
3. Its extension is `.md`
4. Its front matter either:
   - already has a `doc_id`, or  
   - has `status` in `{canonical, draft}`

All other files (especially `_DEV_*` and `.txt`) are **not** ID-eligible and must never be given `doc_id`s.

### 2.3 Front Matter Schema (Simplified)

For `DOC_*` and canonical `PLAN_*` docs, you should expect front matter like:

```yaml
---
doc_id: DOC-ENG-PIPELINE-001       # required for canonical docs
doc_type: design_spec              # guide | phase_report | plan | ...
status: canonical                  # canonical | draft | scratch
ulid: 01JDEX123456789ABC           # ULID for this doc
module_refs:
  - modules/pipeline/
script_refs:
  - scripts/validate_engine.py
---
````

If you create or modify canonical docs, you MUST preserve or improve this structure, never silently delete it.

---

## 3. High-Level Phases (What Happens in What Order)

The doc_id system evolves through these phases:

1. **Phase 1 – Specs**

   * `DOC-NAMING-SPEC.md`
   * `MODULE_LAYOUT_SPEC.md`
   * `DOCID-PROC-001.md`
     These define rules & processes.

2. **Phase 2 – Core Tooling**

   * Implement:

     * `scripts/doc_triage.py`
     * `doc_id_registry_cli.py` with at least:

       * `validate`
       * `batch-mint`
       * `merge-deltas`
       * `generate-index`
       * `stats`

3. **Phase 2.5 – Smoke Test on One Module**

   * Run triage + batch-mint + merge on a **single module folder** (e.g. `modules/pipeline/`) to prove the tools work on a small scope.

4. **Phase 3 – Repo-Wide Triage**

   * Run `doc_triage.py` across the repo.
   * Clean up `_DEV_*`, `DOC_*`, `PLAN_*` naming and locations.

5. **Phase 4 – Registry Migration**

   * Migrate `DOC_ID_REGISTRY.yaml` to conform to the new schema (Pydantic models).
   * Ensure `doc_id_registry_cli.py validate` passes.

6. **Phase 5 – Batch Workflow (Steady State)**

   * Use batch specs and delta files for new doc_ids.
   * No direct bulk editing of the registry.

7. **Phase 6 – CI & AI Integration**

   * CI runs validation on every commit.
   * Copilot and other agents use the CLI tools instead of direct registry edits.

---

## 4. Execution Patterns (New Patterns vs Old Process)

The initial DOC_ID rollout (described in `DOC_ID_EXECUTION_PLAN.md`, `PARALLEL_EXECUTION_STRATEGY.md`, and session reports) had these issues:

* Multiple worktrees writing directly to a shared `DOC_ID_REGISTRY.yaml` file.
* CLI failures (e.g. Unicode/emoji output) causing partial success, then repeated reruns and duplicate entries.
* Index files built manually via interactive AI sessions.
* Heavy reliance on ad hoc instructions instead of a single reproducible process.

The following **execution patterns** are designed to correct those issues.
You MUST follow these patterns when helping with doc_ids.

---

### PATTERN 1 – PAT-DOCID-TRIAGE-001 (Repo Doc Triage)

**Goal:** Classify all Markdown docs and produce a migration queue.

**Tool:** `scripts/doc_triage.py`

**Steps (Copilot):**

1. Ensure `scripts/doc_triage.py` exists with logic roughly equivalent to:

   * Find all `*.md`
   * Skip `.git`, `node_modules`, `.venv`
   * `_DEV_*` outside `developer/**` → mark as `needs_move`
   * Files in `docs/**` that are not `DOC_*` or `PLAN_*` → mark as `needs_rename`
   * `DOC_*` docs without `doc_id` → mark as `needs_mint`
   * Docs with invalid front matter → mark as `needs_fix`

2. Run triage:

   ```bash
   python scripts/doc_triage.py > triage_report.txt
   ```

3. Use the report to:

   * Move `_DEV_*` into `developer/**`
   * Rename real docs to `DOC_*` / `PLAN_*`
   * Build batch specs for `needs_mint` docs

You MUST NOT start a repo-wide rename/minting effort until triage is in place.

---

### PATTERN 2 – PAT-DOCID-SMOKE-001 (Single-Module Smoke Test)

**Goal:** Verify tools on one module before touching the whole repo.

**Scope example:** `modules/pipeline/`

**Steps (Copilot):**

1. Run `doc_triage.py` on that module only (adjust the script or add a `--path` option).

2. Clean up naming for that module’s docs:

   * Move scratch docs → `_DEV_*` under `developer/` or keep as `_DEV_*` in module.
   * Ensure module-local canonical docs are `DOC_*` and have front matter.

3. Create one batch spec for that module’s docs, e.g.:

   ```yaml
   # doc_id/docid_batches/docid_batch_modules_pipeline.yaml
   batch_id: DOCID-BATCH-MODULES-PIPELINE-001
   description: Assign doc_ids to pipeline module docs
   category: docs
   items:
     - logical_name: PIPELINE_OVERVIEW
       title: "Pipeline Engine Overview"
       artifacts:
         - path: modules/pipeline/DOC_PIPELINE_OVERVIEW__v1.md
   tags:
     - type:guide
     - module:pipeline
   ```

4. Run `batch-mint` in **dry-run** mode:

   ```bash
   python doc_id_registry_cli.py \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     batch-mint \
     --batch doc_id/docid_batches/docid_batch_modules_pipeline.yaml \
     --mode dry-run \
     --dry-run-report doc_id/docid_reports/preview_PIPELINE_001.md
   ```

5. If clean, run in **deltas-only** mode:

   ```bash
   python doc_id_registry_cli.py \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     batch-mint \
     --batch doc_id/docid_batches/docid_batch_modules_pipeline.yaml \
     --mode deltas-only \
     --delta-out doc_id/docid_deltas/delta_DOCID_PIPELINE_001.jsonl \
     --no-registry
   ```

6. Merge the delta:

   ```bash
   python doc_id_registry_cli.py \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     merge-deltas \
     doc_id/docid_deltas/delta_DOCID_PIPELINE_001.jsonl \
     --report doc_id/docid_reports/merge_DOCID_PIPELINE_001.md
   ```

7. Validate:

   ```bash
   python doc_id_registry_cli.py validate --duplicates \
     --report doc_id/docid_reports/final_validation_PIPELINE_001.md
   ```

Only after this pattern works end-to-end should you scale to more modules.

---

### PATTERN 3 – PAT-DOCID-BATCH-001 (Batch Mint via Specs & Deltas)

**Goal:** Bulk-assign doc_ids **without** direct concurrent edits to the registry.

**Key Rules (Copilot MUST):**

* Only the **control checkout** (no worktree, or a dedicated control worktree) runs `merge-deltas` and writes `DOC_ID_REGISTRY.yaml`.
* Worktrees and local runs use `--mode deltas-only` and `--no-registry`.

**Steps (for each batch):**

1. Create/extend a batch spec under `doc_id/docid_batches/`, defining:

   * `batch_id`, `description`, `category`
   * `items[]` with `logical_name`, `title`, and `artifacts[].path`

2. Run dry-run:

   ```bash
   python doc_id_registry_cli.py batch-mint \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     --batch doc_id/docid_batches/<batch>.yaml \
     --mode dry-run \
     --dry-run-report doc_id/docid_reports/preview_<batch>.md
   ```

3. If dry-run passes, run deltas-only:

   ```bash
   python doc_id_registry_cli.py batch-mint \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     --batch doc_id/docid_batches/<batch>.yaml \
     --mode deltas-only \
     --delta-out doc_id/docid_deltas/delta_<batch>_001.jsonl \
     --no-registry
   ```

4. On the control checkout (single-writer):

   * Merge one or more delta files with `merge-deltas`.
   * Regenerate indexes with `generate-index`.
   * Run `validate` and `stats`.

This pattern **replaces** the old behavior where each worktree directly edited `DOC_ID_REGISTRY.yaml` and retried after CLI crashes.

---

### PATTERN 4 – PAT-DOCID-MERGE-001 (Controlled Delta Merge)

**Goal:** Ensure registry is updated in a deterministic, auditable way.

**Steps:**

1. Before merging any deltas, create a rollback tag:

   ```bash
   git tag -a "pre-docid-batch-$(date +%Y%m%d-%H%M%S)" \
     -m "Checkpoint before DOC_ID batch"
   ```

2. Merge deltas:

   ```bash
   python doc_id_registry_cli.py \
     --registry doc_id/DOC_ID_REGISTRY.yaml \
     merge-deltas \
     doc_id/docid_deltas/delta_*.jsonl \
     --report doc_id/docid_reports/merge_DOCID_ALL_001.md
   ```

3. If merge fails or introduces bad state:

   * Use rollback:

     ```bash
     git reset --hard pre-docid-batch-YYYYMMDD-HHMMSS
     git worktree prune
     ```

4. If merge succeeds:

   * Commit updated `DOC_ID_REGISTRY.yaml`,
   * Commit merge report + any regenerated indexes.

This pattern directly addresses earlier inefficiencies where partial updates and retries caused duplicate or inconsistent registry entries.

---

### PATTERN 5 – PAT-DOCID-WT-001 (Safe Worktree Usage)

**Goal:** Use Git worktrees without reintroducing shared-write hazards.

**Rules (Copilot MUST):**

* Worktrees are for **per-scope edits** (e.g. docs in `docs/`, or module folders), not for direct registry writes.
* Worktrees may:

  * rename/move docs,
  * edit front matter,
  * create batch specs,
  * generate deltas with `batch-mint --mode deltas-only`.
* They must **not** call `merge-deltas`.

**Example flow:**

1. On main checkout (control):

   ```bash
   git checkout feat/docid-rollout
   git worktree add .worktrees/docid-docs feat/docid-rollout
   git worktree add .worktrees/docid-modules feat/docid-rollout
   ```

2. In `.worktrees/docid-docs`:

   * Run `doc_triage.py` scoped to docs.
   * Fix naming + front matter.
   * Create batch specs.
   * Run `batch-mint` in deltas-only mode.
   * Commit changes to that worktree branch.

3. In main checkout:

   * Pull deltas from both worktrees (or ensure they’re visible in `doc_id/docid_deltas/`).
   * Run `merge-deltas` and `validate`.
   * Run full tests.
   * Commit updated registry + indexes.

This replaces the earlier pattern where each worktree wrote directly to the registry and AI had to manage cross-worktree conflicts manually.

---

## 5. Behavior Rules For Copilot (Summary)

When you, Copilot, are asked to:

* **Create a new canonical doc**:

  * Name it `DOC_*`.
  * Place it in `docs/**` or `modules/**`.
  * Add front matter with `status: draft` at minimum.
  * **Do not** invent `doc_id` manually; instead, prepare a batch spec and call `batch-mint`.

* **Create a future plan**:

  * Name it `PLAN_*`.
  * Place under `workstreams/plans/**` (or `docs/plans/**` as configured).
  * Use `status: draft` until it’s approved.
  * Only after `status: canonical` should it be given a `doc_id` via batch-mint.

* **Write scratch notes or temporary summaries**:

  * Name them `_DEV_*`.
  * Place under `developer/**` (or as `_DEV_*` within a module).
  * Never add `doc_id` to these.

* **Modify the registry**:

  * Prefer `doc_id_registry_cli.py` commands:

    * `batch-mint`, `merge-deltas`, `generate-index`, `validate`, `stats`.
  * Never hand-edit `DOC_ID_REGISTRY.yaml` in bulk.
  * Never write to `DOC_ID_REGISTRY.yaml` from multiple worktrees.

* **Run large-scale changes**:

  * Use PAT-DOCID-SMOKE-001 on a single module first.
  * Then scale using PAT-DOCID-BATCH-001 + PAT-DOCID-MERGE-001.
  * Always set a rollback tag before merging deltas.

---

## 6. Success Criteria

Copilot has succeeded when:

* `scripts/doc_triage.py` reports **zero violations** after cleanup.
* `doc_id_registry_cli.py validate` passes without errors.
* New docs are always created with correct naming, front matter, and IDs via batch-mint.
* `DOC_ID_REGISTRY.yaml` is only ever updated via `merge-deltas`.
* CI checks run validation automatically and rarely fail due to doc_id issues.

If any of these conditions are not met, you SHOULD propose corrections using the patterns in this guide instead of ad hoc fixes.

---

```
::contentReference[oaicite:0]{index=0}
```

