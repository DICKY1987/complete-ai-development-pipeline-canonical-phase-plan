---
doc_id: DOC-GUIDE-AUDIT-RETENTION-810
---

# Audit Retention Policy

## Purpose

This document defines the retention, rotation, and archival policies for audit logs generated by the orchestration system.

## Scope

This policy applies to all audit logs maintained by the system:
- `.state/transitions.jsonl` - State transition event log
- `.state/logs/*.log` - Task execution logs
- `.state/logs/worker_*.log` - Worker process logs
- `.state/archive/` - Archived workstream states

## Retention Requirements

### Production Environment

**Primary Audit Log** (`.state/transitions.jsonl`):
- **Retention Period**: 90 days minimum
- **Rotation**: Daily at 00:00 UTC
- **Archive Location**: `.state/archive/transitions/`
- **Archive Format**: Compressed JSONL (`.jsonl.gz`)
- **Archive Retention**: 1 year

**Task Logs** (`.state/logs/*.log`):
- **Retention Period**: 30 days
- **Rotation**: Per task completion
- **Archive Location**: `.state/archive/task_logs/`
- **Archive Format**: Compressed text (`.log.gz`)
- **Archive Retention**: 90 days

**Worker Logs** (`.state/logs/worker_*.log`):
- **Retention Period**: 7 days
- **Rotation**: Daily or when size > 100MB
- **Archive Location**: `.state/archive/worker_logs/`
- **Archive Format**: Compressed text (`.log.gz`)
- **Archive Retention**: 30 days

**Workstream Archives** (`.state/archive/{workstream_id}/`):
- **Retention Period**: Indefinite for failed workstreams
- **Retention Period**: 90 days for completed workstreams
- **Archive Format**: Directory with full state snapshot
- **Deletion**: Manual review required for failed workstreams

### Development Environment

**All Logs**:
- **Retention Period**: 7 days
- **Rotation**: Daily
- **Archive**: Not archived in development
- **Deletion**: Automatic after retention period

## Rotation Policy

### Automatic Rotation

Logs are rotated automatically based on:
1. **Time-based**: Daily rotation at 00:00 UTC
2. **Size-based**: When log file exceeds configured size (default: 100MB)
3. **Event-based**: When workstream completes or fails

### Rotation Process

```bash
# Automatic rotation via cron
0 0 * * * /opt/orchestrator/scripts/rotate_logs.sh

# Rotation process:
1. Close current log file
2. Rename with timestamp: transitions.jsonl -> transitions_20240115.jsonl
3. Compress: transitions_20240115.jsonl -> transitions_20240115.jsonl.gz
4. Move to archive: .state/archive/transitions/transitions_20240115.jsonl.gz
5. Create new empty log file
6. Update log file permissions
```

### Manual Rotation

To manually rotate logs:

```bash
python scripts/rotate_logs.py --force --component transitions
python scripts/rotate_logs.py --force --component task_logs
python scripts/rotate_logs.py --force --component worker_logs
```

## Archive Format

### Compressed Archives

All archives use gzip compression:

```bash
# Original
transitions.jsonl (150 MB)

# Archived
transitions_20240115.jsonl.gz (12 MB, ~92% compression)
```

### Archive Structure

```
.state/archive/
├── transitions/
│   ├── 2024/
│   │   ├── 01/
│   │   │   ├── transitions_20240115.jsonl.gz
│   │   │   ├── transitions_20240116.jsonl.gz
│   │   │   └── ...
│   │   └── ...
│   └── ...
├── task_logs/
│   ├── 2024/
│   │   ├── 01/
│   │   │   ├── task-ulid-001.log.gz
│   │   │   └── ...
│   │   └── ...
│   └── ...
├── worker_logs/
│   ├── 2024/
│   │   ├── 01/
│   │   │   ├── worker-001_20240115.log.gz
│   │   │   └── ...
│   │   └── ...
│   └── ...
└── workstreams/
    ├── ws-ulid-001/
    │   ├── current.json
    │   ├── dag.json
    │   ├── execution_plan.json
    │   ├── tasks/
    │   └── metadata.json
    └── ...
```

## Query and Access

### Querying Archived Logs

Archived logs remain queryable:

```bash
# Query transitions from archived log
zcat .state/archive/transitions/2024/01/transitions_20240115.jsonl.gz | \
  jq 'select(.workstream_id == "ws-ulid-001")'

# Query task logs
zcat .state/archive/task_logs/2024/01/task-ulid-001.log.gz | \
  grep "ERROR"

# Query specific time range
python scripts/query_archives.py \
  --component transitions \
  --from "2024-01-15T00:00:00Z" \
  --to "2024-01-15T23:59:59Z" \
  --filter 'event=="task_failed"'
```

### Access Control

- **Read Access**: Orchestrator processes, administrators, audit tools
- **Write Access**: Orchestrator processes only
- **Delete Access**: Administrators only, with approval
- **Archive Access**: Read-only for all authorized users

## Deletion Policy

### Automatic Deletion

Logs are automatically deleted after retention period:

```bash
# Daily cleanup job (cron)
0 1 * * * /opt/orchestrator/scripts/cleanup_archives.sh

# Cleanup process:
1. Scan archive directories
2. Identify files older than retention period
3. Verify files are archived correctly
4. Delete eligible files
5. Log deletion events
```

### Manual Deletion

Manual deletion requires:
1. **Justification**: Document reason for early deletion
2. **Approval**: Senior administrator approval
3. **Verification**: Confirm no compliance violations
4. **Logging**: Log deletion event with justification

```bash
# Manual deletion with logging
python scripts/delete_archive.py \
  --file .state/archive/transitions/2024/01/transitions_20240101.jsonl.gz \
  --reason "Test data, not production" \
  --approved-by "admin@example.com"
```

### Protected Logs

Some logs are protected from automatic deletion:
- Failed workstream archives (manual review required)
- Logs involved in active investigations
- Logs flagged for compliance audit
- Logs within compliance retention window (1 year minimum)

## Compliance

### Regulatory Requirements

This policy supports compliance with:
- **SOC 2 Type II**: Audit trail for security events
- **GDPR**: Right to erasure (manual process)
- **HIPAA**: 6-year retention (if applicable)
- **Internal Audit**: 1-year minimum retention

### Audit Trail Completeness

Archived logs must enable:
1. **Reconstruction**: Rebuild system state at any point in time
2. **Causality**: Answer "why did X happen?" questions
3. **Accountability**: Track who did what and when
4. **Compliance**: Generate compliance reports on demand

### Verification

Monthly verification ensures:
- Archives are readable and not corrupted
- Compression ratios are acceptable (>80%)
- Retention periods are enforced
- No gaps in audit trail

```bash
# Monthly verification (cron)
0 2 1 * * /opt/orchestrator/scripts/verify_archives.sh

# Verification checks:
1. Test decompression of random sample (10%)
2. Verify JSON validity of transitions
3. Check for timeline gaps
4. Validate file permissions
5. Report any issues
```

## Monitoring

### Metrics

Track archive health metrics:
- **Archive size**: Total size of all archives
- **Compression ratio**: Average compression achieved
- **Archive age**: Age of oldest and newest archives
- **Gap detection**: Missing days in audit trail
- **Access frequency**: How often archives are queried

### Alerts

Alert on:
- **Archive failure**: Rotation or compression failed
- **Retention violation**: Files not deleted after retention period
- **Gap detected**: Missing audit events for >1 hour
- **Corruption detected**: Archive file failed verification
- **Disk space**: Archive partition >80% full

## Disaster Recovery

### Backup

Archives are backed up to separate storage:
- **Frequency**: Daily incremental, weekly full backup
- **Location**: Off-site backup storage
- **Encryption**: AES-256 encryption at rest
- **Retention**: Same as primary archives

### Recovery

To recover from archive loss:

```bash
# Restore from backup
python scripts/restore_archives.py \
  --from-backup /backup/orchestrator/archives/ \
  --to .state/archive/ \
  --verify

# Rebuild from surviving logs if backup unavailable
python scripts/rebuild_archive.py \
  --from .state/transitions.jsonl \
  --output .state/archive/transitions/
```

## Migration

When updating archive policies:
1. **Document Changes**: Update this document
2. **Migrate Existing**: Apply new retention to existing archives
3. **Verify**: Ensure no data loss during migration
4. **Communicate**: Notify stakeholders of changes

## See Also

- [Audit Trail Requirements](../../specifications/content/orchestration/spec.md#audit-trail)
- [State Observability](../../specifications/content/orchestration/spec.md#state-observability)
- [Compliance Validation](../../specifications/content/orchestration/spec.md#compliance-validation)
