%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px'}}}%%
graph TD
    %% Source Code
    CODE["ğŸ’» Source Code<br/><small>Python, JS, YAML, etc.</small>"]
    
    %% Detection Trigger
    TRIGGER["ğŸ”” Detection Trigger<br/><small>Manual or Automated</small>"]
    
    %% Error Engine
    ERROR_ENGINE["ğŸ” Error Engine<br/><small>error.engine.error_engine</small>"]
    LOAD_PLUGINS["ğŸ”Œ Load Plugins<br/><small>error.plugin_manager</small>"]
    
    %% State Machine
    STATE_MACHINE["âš¡ State Machine<br/><small>error.engine.error_state_machine</small>"]
    
    %% Plugin Execution
    SELECT_PLUGINS["ğŸ¯ Select Relevant Plugins<br/><small>Based on file types</small>"]
    
    PYTHON_PLUGINS["ğŸ Python Plugins<br/><small>ruff, mypy, black, pylint</small>"]
    JS_PLUGINS["ğŸ“œ JavaScript Plugins<br/><small>eslint, prettier</small>"]
    YAML_PLUGINS["ğŸ“ YAML Plugins<br/><small>yamllint</small>"]
    MD_PLUGINS["ğŸ“„ Markdown Plugins<br/><small>markdownlint, mdformat</small>"]
    SECURITY_PLUGINS["ğŸ”’ Security Plugins<br/><small>bandit, semgrep, gitleaks</small>"]
    
    %% Result Processing
    COLLECT_RESULTS["ğŸ“Š Collect Results<br/><small>Aggregate findings</small>"]
    CLASSIFY["ğŸ·ï¸ Classify Errors<br/><small>Severity, type, category</small>"]
    
    %% State Transitions
    STATE_NEW["ğŸ†• NEW"]
    STATE_DETECTED["ğŸ” DETECTED"]
    STATE_FIXED["âœ… FIXED"]
    STATE_IGNORED["â­ï¸ IGNORED"]
    
    %% Database Storage
    STORE_DB["ğŸ’¾ Store in Database<br/><small>core.state.crud</small>"]
    STORE_JSONL["ğŸ“ Append to JSONL<br/><small>pipeline_errors.jsonl</small>"]
    
    %% Auto-Fix
    AUTO_FIX["ğŸ”§ Auto-Fix<br/><small>black, prettier, isort</small>"]
    VERIFY_FIX["âœ… Verify Fix<br/><small>Re-run detection</small>"]
    
    %% Reporting
    GENERATE_REPORT["ğŸ“‹ Generate Report<br/><small>CLI or Service</small>"]
    
    %% Output
    RESULTS["ğŸ“Š Error Report<br/><small>Console, File, or API</small>"]
    
    %% Flow
    CODE --> TRIGGER
    TRIGGER --> ERROR_ENGINE
    ERROR_ENGINE --> LOAD_PLUGINS
    LOAD_PLUGINS --> STATE_MACHINE
    
    STATE_MACHINE --> SELECT_PLUGINS
    
    SELECT_PLUGINS --> PYTHON_PLUGINS
    SELECT_PLUGINS --> JS_PLUGINS
    SELECT_PLUGINS --> YAML_PLUGINS
    SELECT_PLUGINS --> MD_PLUGINS
    SELECT_PLUGINS --> SECURITY_PLUGINS
    
    PYTHON_PLUGINS --> COLLECT_RESULTS
    JS_PLUGINS --> COLLECT_RESULTS
    YAML_PLUGINS --> COLLECT_RESULTS
    MD_PLUGINS --> COLLECT_RESULTS
    SECURITY_PLUGINS --> COLLECT_RESULTS
    
    COLLECT_RESULTS --> CLASSIFY
    CLASSIFY --> STATE_NEW
    
    STATE_NEW -->|"Error Detected"| STATE_DETECTED
    STATE_DETECTED -->|"Auto-Fix Available"| AUTO_FIX
    STATE_DETECTED -->|"Manual Fix"| STORE_DB
    STATE_DETECTED -->|"False Positive"| STATE_IGNORED
    
    AUTO_FIX --> VERIFY_FIX
    VERIFY_FIX -->|"Fixed"| STATE_FIXED
    VERIFY_FIX -->|"Still Failing"| STATE_DETECTED
    
    STATE_FIXED --> STORE_DB
    STATE_IGNORED --> STORE_DB
    
    STORE_DB --> STORE_JSONL
    STORE_JSONL --> GENERATE_REPORT
    GENERATE_REPORT --> RESULTS
    
    %% Styling
    classDef sourceStyle fill:#9B59B6,stroke:#6C3483,stroke-width:2px,color:#fff
    classDef engineStyle fill:#E24A4A,stroke:#8A2E2E,stroke-width:2px,color:#fff
    classDef pluginStyle fill:#3498DB,stroke:#2874A6,stroke-width:2px,color:#fff
    classDef stateStyle fill:#F39C12,stroke:#D68910,stroke-width:2px,color:#fff
    classDef fixStyle fill:#27AE60,stroke:#1E8449,stroke-width:2px,color:#fff
    classDef outputStyle fill:#95A5A6,stroke:#7F8C8D,stroke-width:2px,color:#fff
    
    class CODE,TRIGGER sourceStyle
    class ERROR_ENGINE,LOAD_PLUGINS,STATE_MACHINE,SELECT_PLUGINS,COLLECT_RESULTS,CLASSIFY engineStyle
    class PYTHON_PLUGINS,JS_PLUGINS,YAML_PLUGINS,MD_PLUGINS,SECURITY_PLUGINS pluginStyle
    class STATE_NEW,STATE_DETECTED,STATE_FIXED,STATE_IGNORED stateStyle
    class AUTO_FIX,VERIFY_FIX fixStyle
    class STORE_DB,STORE_JSONL,GENERATE_REPORT,RESULTS outputStyle
