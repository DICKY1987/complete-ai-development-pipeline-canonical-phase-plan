%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px'}}}%%
graph TD
    %% Components that interact with DB
    ORCHESTRATOR["‚öôÔ∏è Orchestrator<br/><small>core.engine.orchestrator</small>"]
    SCHEDULER["üìÖ Scheduler<br/><small>core.engine.scheduler</small>"]
    EXECUTOR["‚ñ∂Ô∏è Executor<br/><small>core.engine.executor</small>"]
    ERROR_ENGINE["üîç Error Engine<br/><small>error.engine.error_engine</small>"]
    PLANNER["üß† Planner<br/><small>core.planning.planner</small>"]

    %% CRUD Layer
    CRUD["üìù CRUD Operations<br/><small>core.state.crud</small>"]

    %% Database Operations
    subgraph DB_OPS["üíæ Database Operations"]
        direction TB

        CREATE_RUN["Create Run"]
        CREATE_WS["Create Workstream"]
        CREATE_STEP["Create Step"]
        CREATE_ERROR["Create Error"]
        CREATE_EVENT["Create Event"]

        READ_RUN["Read Run"]
        READ_WS["Read Workstream"]
        READ_STEP["Read Step"]
        READ_ERROR["Read Error"]

        UPDATE_RUN["Update Run Status"]
        UPDATE_STEP["Update Step Status"]
        UPDATE_ERROR["Update Error State"]

        LIST_RUNS["List Runs"]
        LIST_WS["List Workstreams"]
        LIST_ERRORS["List Errors"]
    end

    %% Database Backend
    DB_SQLITE["üíæ SQLite Backend<br/><small>core.state.db_sqlite</small>"]

    %% Database File
    DB_FILE[("üóÑÔ∏è refactor_paths.db<br/><small>SQLite Database</small>")]

    %% Tables
    subgraph TABLES["üìä Database Tables"]
        direction LR

        T_RUNS["runs"]
        T_WORKSTREAMS["workstreams"]
        T_STEPS["steps"]
        T_ERRORS["errors"]
        T_EVENTS["events"]
    end

    %% Flow - Components to CRUD
    ORCHESTRATOR --> CRUD
    SCHEDULER --> CRUD
    EXECUTOR --> CRUD
    ERROR_ENGINE --> CRUD
    PLANNER --> CRUD

    %% Flow - CRUD to DB Operations
    CRUD --> CREATE_RUN
    CRUD --> CREATE_WS
    CRUD --> CREATE_STEP
    CRUD --> CREATE_ERROR
    CRUD --> CREATE_EVENT
    CRUD --> READ_RUN
    CRUD --> READ_WS
    CRUD --> READ_STEP
    CRUD --> READ_ERROR
    CRUD --> UPDATE_RUN
    CRUD --> UPDATE_STEP
    CRUD --> UPDATE_ERROR
    CRUD --> LIST_RUNS
    CRUD --> LIST_WS
    CRUD --> LIST_ERRORS

    %% Flow - DB Operations to Backend
    CREATE_RUN --> DB_SQLITE
    CREATE_WS --> DB_SQLITE
    CREATE_STEP --> DB_SQLITE
    CREATE_ERROR --> DB_SQLITE
    CREATE_EVENT --> DB_SQLITE
    READ_RUN --> DB_SQLITE
    READ_WS --> DB_SQLITE
    READ_STEP --> DB_SQLITE
    READ_ERROR --> DB_SQLITE
    UPDATE_RUN --> DB_SQLITE
    UPDATE_STEP --> DB_SQLITE
    UPDATE_ERROR --> DB_SQLITE
    LIST_RUNS --> DB_SQLITE
    LIST_WS --> DB_SQLITE
    LIST_ERRORS --> DB_SQLITE

    %% Flow - Backend to File
    DB_SQLITE --> DB_FILE

    %% Flow - File to Tables
    DB_FILE --> T_RUNS
    DB_FILE --> T_WORKSTREAMS
    DB_FILE --> T_STEPS
    DB_FILE --> T_ERRORS
    DB_FILE --> T_EVENTS

    %% Styling
    classDef componentStyle fill:#4A90E2,stroke:#2E5C8A,stroke-width:2px,color:#fff
    classDef crudStyle fill:#3498DB,stroke:#2874A6,stroke-width:2px,color:#fff
    classDef operationStyle fill:#F39C12,stroke:#D68910,stroke-width:2px,color:#fff
    classDef dbStyle fill:#27AE60,stroke:#1E8449,stroke-width:2px,color:#fff
    classDef tableStyle fill:#95A5A6,stroke:#7F8C8D,stroke-width:2px,color:#fff

    class ORCHESTRATOR,SCHEDULER,EXECUTOR,ERROR_ENGINE,PLANNER componentStyle
    class CRUD crudStyle
    class CREATE_RUN,CREATE_WS,CREATE_STEP,CREATE_ERROR,CREATE_EVENT,READ_RUN,READ_WS,READ_STEP,READ_ERROR,UPDATE_RUN,UPDATE_STEP,UPDATE_ERROR,LIST_RUNS,LIST_WS,LIST_ERRORS operationStyle
    class DB_SQLITE,DB_FILE dbStyle
    class T_RUNS,T_WORKSTREAMS,T_STEPS,T_ERRORS,T_EVENTS tableStyle
