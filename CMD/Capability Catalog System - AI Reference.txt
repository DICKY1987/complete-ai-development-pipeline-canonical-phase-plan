# Capability Catalog System - AI Reference

## Core Pattern: Card → Ledger → Registry

**Identity:** Immutable ULID + human-readable key  
**Versioning:** SemVer for capability evolution  
**Audit:** Append-only JSONL for every operation  
**Discovery:** SQLite FTS5 (<1ms) + YAML registry  

---

## File Structure

```
capabilities/
├─ cards/                    # Source of truth (git)
│  └─ {ULID}_{KEY}.yaml     # One per capability
├─ registry/
│  ├─ capabilities.db       # SQLite FTS5 search
│  └─ registry.yaml         # Human index
├─ .ledger/
│  └─ capabilities.jsonl    # Append-only events
├─ verify/                  # Prereq check scripts
│  └─ *.ps1
└─ manifests/               # Plugin contracts
   └─ PLG_*.yaml
```

---

## Capability Card Schema

```yaml
ulid: 01JC4GHPR82XYZ...           # Immutable
key: cap.gh.pr.create.v1          # Alias
semver: 1.0.0
status: active
intents:
  - pattern: "(create|open).*(pr|pull request)"
    confidence: 0.92
prerequisites:
  - check: "gh auth status"
    verify: verify/gh_auth_status.ps1
command: "gh pr create --base {base} --fill"
platforms: [windows, macos, linux]
toolchain: [gh >= 2.0]
```

---

## Agent Resolution Protocol

**Input (stdin JSON):**
```json
{"intent":"create PR","context":{"repo":true,"auth":true}}
```

**Output (stdout JSON):**
```json
{
  "capability_ulid": "01JC4GHPR...",
  "key": "cap.gh.pr.create.v1",
  "confidence": 0.92,
  "verified": true,
  "command": "gh pr create --base main --fill",
  "audit_event_ulid": "01JC4EVT..."
}
```

**Call pattern:**
```bash
echo '{"intent":"...","context":{...}}' | pwsh Resolve-Capability.ps1
```

---

## Ledger Event Types

```jsonl
{"event_ulid":"...","ts":"2025-11-11T14:22:00Z","type":"RESOLVE","subject_ulid":"...","payload":{"intent":"create PR","confidence":0.92},"actor":{"by":"aider-cli"}}
{"event_ulid":"...","ts":"2025-11-11T14:22:01Z","type":"VERIFY","subject_ulid":"...","payload":{"prereq":"gh_auth","result":"pass","duration_ms":45}}
{"event_ulid":"...","ts":"2025-11-11T14:22:02Z","type":"EXECUTE","subject_ulid":"...","payload":{"exit_code":0,"duration_ms":1234}}
```

---

## SQLite FTS5 Search

```sql
-- Instant lookup
SELECT ulid FROM capability_search 
WHERE intents MATCH 'create AND (pr OR issue)' 
LIMIT 5;
```

---

## CI Validation Levels

**L0 Static:** Schema validation, YAML lint  
**L1 Contract:** Manifest conformance, verify script tests  
**L2 Behavior:** BDD resolution scenarios  
**L3 Integration:** Full resolver with real tools  
**L5 Security:** SBOM, secrets scan  

**Green → Auto-rebuild registry + SQLite**

---

## Resolution Algorithm

1. **Parse intent** → extract keywords
2. **FTS5 query** → get candidate ULIDs (scored)
3. **Load cards** → filter by platform/tool/status
4. **Run verify/** → check prerequisites (cached 5-15min)
5. **Return** → highest verified + command template
6. **Log** → RESOLVE/VERIFY/EXECUTE events to ledger

---

## Agent Integration Snippet

```python
import json, subprocess, ulid

def resolve(intent: str, context: dict) -> dict:
    inp = json.dumps({"intent": intent, "context": context})
    result = subprocess.run(["pwsh", "Resolve-Capability.ps1"], 
                          input=inp, capture_output=True, text=True)
    return json.loads(result.stdout)

# Usage
cap = resolve("create GitHub PR", {"repo": True, "auth": True})
if cap["verified"]:
    subprocess.run(cap["command"], shell=True)
```

---

## Policy Gates

**One-capability rule:** PR touches only one card (optional)  
**Immutable ULIDs:** Keys never reused  
**SemVer enforcement:** CI blocks merges without version bump  
**Uniqueness:** Registry validates no duplicate keys  

---

## Query Patterns

**Audit:**  
`grep '"type":"EXECUTE"' .ledger/capabilities.jsonl | jq -r .subject_ulid | sort | uniq -c`

**Gap analysis:**  
`grep '"type":"RESOLVE".*"verified":false' .ledger/capabilities.jsonl`

**Success rate:**  
`SELECT key, COUNT(*) as uses, AVG(CASE WHEN result='pass' THEN 1.0 ELSE 0.0 END) FROM ledger GROUP BY key`

---

## Key Differences: Headless vs Web-UI

| Aspect | Web-UI | Headless |
|--------|--------|----------|
| Interface | HTTP REST | JSON stdin/stdout |
| Storage | Centralized DB | Distributed YAML + SQLite cache |
| Updates | Hot reload | CI rebuild + publish |
| Audit | Real-time metrics | JSONL ledger + grep |

---

## System Prompt Addition

```markdown
<capability_catalog>
Before proposing custom automation:
1. Call: echo '{"intent":"<task>"}' | pwsh Resolve-Capability.ps1
2. If verified capability returned, use its command verbatim
3. Cite capability_key in response
4. Only write custom code if no verified capability exists

Location: /path/to/capabilities/
Contract: JSON stdin → JSON stdout
Logs: .ledger/capabilities.jsonl (audit trail)
</capability_catalog>
```

---

**Implementation time:** 2-3 days for 30 capabilities + resolver + CI gates