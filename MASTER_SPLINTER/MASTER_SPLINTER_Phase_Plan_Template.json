{
  "doc_id": "DOC-PHASE-TEMPLATE-V3-XXX",
  "template_version": 3,
  "table_of_contents": {
    "sections": [
      {
        "id": "phase_identity",
        "title": "Phase identity",
        "key_path": "phase_identity"
      },
      {
        "id": "dag_and_dependencies",
        "title": "DAG and dependencies",
        "key_path": "dag_and_dependencies"
      },
      {
        "id": "scope_and_modules",
        "title": "Scope and modules",
        "key_path": "scope_and_modules"
      },
      {
        "id": "environment_and_tools",
        "title": "Environment and tools",
        "key_path": "environment_and_tools"
      },
      {
        "id": "execution_profile",
        "title": "Execution profile",
        "key_path": "execution_profile"
      },
      {
        "id": "pre_flight_checks",
        "title": "Pre-flight checks",
        "key_path": "pre_flight_checks"
      },
      {
        "id": "execution_plan",
        "title": "Execution plan",
        "key_path": "execution_plan"
      },
      {
        "id": "fix_loop_and_circuit_breakers",
        "title": "Fix loop and circuit breakers",
        "key_path": "fix_loop_and_circuit_breakers"
      },
      {
        "id": "expected_artifacts",
        "title": "Expected artifacts",
        "key_path": "expected_artifacts"
      },
      {
        "id": "acceptance_tests",
        "title": "Acceptance tests",
        "key_path": "acceptance_tests"
      },
      {
        "id": "completion_gate",
        "title": "Completion gate",
        "key_path": "completion_gate"
      },
      {
        "id": "observability_and_metrics",
        "title": "Observability and metrics",
        "key_path": "observability_and_metrics"
      },
      {
        "id": "governance_and_constraints",
        "title": "Governance and constraints",
        "key_path": "governance_and_constraints"
      },
      {
        "id": "extensions",
        "title": "Extensions",
        "key_path": "extensions"
      }
    ]
  },
  "index": {
    "parameters": {
      "PHASE_ID": {
        "path": "/phase_identity/phase_id",
        "description": "The phase_id of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "WORKSTREAM_ID": {
        "path": "/phase_identity/workstream_id",
        "description": "The workstream_id of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "TITLE": {
        "path": "/phase_identity/title",
        "description": "The title of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "SUMMARY": {
        "path": "/phase_identity/summary",
        "description": "The summary of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "OBJECTIVE": {
        "path": "/phase_identity/objective",
        "description": "The objective of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "PHASE_TYPE": {
        "path": "/phase_identity/phase_type",
        "description": "The phase_type of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "STATUS": {
        "path": "/phase_identity/status",
        "description": "The status of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "ESTIMATE_HOURS": {
        "path": "/phase_identity/estimate_hours",
        "description": "The estimate_hours of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "GH_ITEM_ID": {
        "path": "/phase_identity/gh_item_id",
        "description": "The gh_item_id of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "TAGS": {
        "path": "/phase_identity/tags",
        "description": "The tags of the phase",
        "tags": [
          "param",
          "phase_identity"
        ]
      },
      "WORKSTREAM_BUNDLE_ID": {
        "path": "/dag_and_dependencies/workstream_bundle_id",
        "description": "The workstream_bundle_id of the dag and dependencies",
        "tags": [
          "param",
          "dag_and_dependencies"
        ]
      },
      "DEPENDS_ON": {
        "path": "/dag_and_dependencies/depends_on",
        "description": "The depends_on of the dag and dependencies",
        "tags": [
          "param",
          "dag_and_dependencies"
        ]
      },
      "MAY_RUN_PARALLEL_WITH": {
        "path": "/dag_and_dependencies/may_run_parallel_with",
        "description": "The may_run_parallel_with of the dag and dependencies",
        "tags": [
          "param",
          "dag_and_dependencies"
        ]
      },
      "PARALLEL_GROUP": {
        "path": "/dag_and_dependencies/parallel_group",
        "description": "The parallel_group of the dag and dependencies",
        "tags": [
          "param",
          "dag_and_dependencies"
        ]
      },
      "IS_CRITICAL_PATH": {
        "path": "/dag_and_dependencies/is_critical_path",
        "description": "The is_critical_path of the dag and dependencies",
        "tags": [
          "param",
          "dag_and_dependencies"
        ]
      }
    },
    "sections": {
      "S_PHASE_IDENTITY": {
        "path": "/phase_identity",
        "description": "Phase identity",
        "tags": [
          "phase_identity"
        ]
      },
      "S_DAG_AND_DEPENDENCIES": {
        "path": "/dag_and_dependencies",
        "description": "DAG and dependencies",
        "tags": [
          "dag_and_dependencies"
        ]
      },
      "S_SCOPE_AND_MODULES": {
        "path": "/scope_and_modules",
        "description": "Scope and modules",
        "tags": [
          "scope_and_modules"
        ]
      },
      "S_ENVIRONMENT_AND_TOOLS": {
        "path": "/environment_and_tools",
        "description": "Environment and tools",
        "tags": [
          "environment_and_tools"
        ]
      },
      "S_EXECUTION_PROFILE": {
        "path": "/execution_profile",
        "description": "Execution profile",
        "tags": [
          "execution_profile"
        ]
      },
      "S_PRE_FLIGHT_CHECKS": {
        "path": "/pre_flight_checks",
        "description": "Pre-flight checks",
        "tags": [
          "pre_flight_checks"
        ]
      },
      "S_EXECUTION_PLAN": {
        "path": "/execution_plan",
        "description": "Execution plan",
        "tags": [
          "execution_plan"
        ]
      },
      "S_FIX_LOOP_AND_CIRCUIT_BREAKERS": {
        "path": "/fix_loop_and_circuit_breakers",
        "description": "Fix loop and circuit breakers",
        "tags": [
          "fix_loop_and_circuit_breakers"
        ]
      },
      "S_EXPECTED_ARTIFACTS": {
        "path": "/expected_artifacts",
        "description": "Expected artifacts",
        "tags": [
          "expected_artifacts"
        ]
      },
      "S_ACCEPTANCE_TESTS": {
        "path": "/acceptance_tests",
        "description": "Acceptance tests",
        "tags": [
          "acceptance_tests"
        ]
      },
      "S_COMPLETION_GATE": {
        "path": "/completion_gate",
        "description": "Completion gate",
        "tags": [
          "completion_gate"
        ]
      },
      "S_OBSERVABILITY_AND_METRICS": {
        "path": "/observability_and_metrics",
        "description": "Observability and metrics",
        "tags": [
          "observability_and_metrics"
        ]
      },
      "S_GOVERNANCE_AND_CONSTRAINTS": {
        "path": "/governance_and_constraints",
        "description": "Governance and constraints",
        "tags": [
          "governance_and_constraints"
        ]
      },
      "S_EXTENSIONS": {
        "path": "/extensions",
        "description": "Extensions",
        "tags": [
          "extensions"
        ]
      }
    }
  },
  "phase_identity": {
    "phase_id": "PH-XX",
    "workstream_id": "ws-xxx",
    "title": "Short human-readable phase name",
    "summary": "Single-paragraph summary of the outcome this phase must produce.",
    "objective": "Definition of done phrased as the phase objective.",
    "phase_type": "implementation",
    "status": "planned",
    "estimate_hours": 0,
    "gh_item_id": null,
    "tags": [
      "state_layer",
      "orchestrator",
      "pipeline_core"
    ]
  },
  "dag_and_dependencies": {
    "workstream_bundle_id": "ws-bundle-xx",
    "depends_on": [
      "PH-00",
      "PH-01"
    ],
    "may_run_parallel_with": [
      "PH-10"
    ],
    "parallel_group": "core-pipeline-v1",
    "is_critical_path": true
  },
  "scope_and_modules": {
    "repo_root": ".",
    "modules": [
      {
        "module_id": "mod.core.state",
        "description": "SQLite-backed state DB and state machine"
      },
      {
        "module_id": "mod.pipeline.orchestrator",
        "description": "Main orchestrator entrypoints"
      }
    ],
    "file_scope": {
      "read_only": [
        "README.md",
        "docs/**/*.md",
        "config/**/*.yaml"
      ],
      "modify": [
        "src/pipeline/**/*.py",
        "tests/pipeline/**/*.py"
      ],
      "create": [
        "schema/**/*.sql",
        "docs/state/**/*.md",
        "scripts/**/*.py"
      ],
      "forbidden_paths": [
        ".git/**",
        ".venv/**",
        ".worktrees/**"
      ]
    },
    "worktree_strategy": {
      "mode": "per_workstream",
      "name_pattern": "wt-${workstream_id}-${phase_id}",
      "base_branch": "main",
      "multi_worktree_enabled": false,
      "worktrees": [
        {
          "id": "WT-EXAMPLE",
          "scope": [
            "docs/**"
          ],
          "branch_pattern": "feature/${phase_id}-${workstream_id}-${id}"
        }
      ]
    }
  },
  "environment_and_tools": {
    "target_os": "windows",
    "default_shell": "powershell",
    "primary_language": "python",
    "python": {
      "version_constraint": ">=3.11,<3.13",
      "venv_path": ".venv"
    },
    "required_services": [
      {
        "name": "sqlite_db",
        "type": "file",
        "path": ".state/pipeline.db",
        "must_exist_before_phase": false
      }
    ],
    "config_files": [
      "config/tool_profiles.json",
      "config/circuit_breakers.yaml"
    ],
    "ai_operators": {
      "primary_agent": "codex",
      "secondary_agents": [
        "claude-code",
        "aider"
      ]
    },
    "tool_profiles": {
      "preferred_ids": [
        "pytest",
        "ruff",
        "black",
        "powershell-script",
        "aider-edit",
        "aider-fix"
      ]
    }
  },
  "execution_profile": {
    "prompt_template_id": "EXECUTION_PROMPT_TEMPLATE_V2_DAG_MULTI_WORKSTREAM",
    "run_mode": "execute",
    "max_runtime_minutes": 60,
    "concurrency": {
      "allowed_for_phase": true,
      "max_parallel_steps": 1
    },
    "retry_policy": {
      "default_max_attempts": 1
    }
  },
  "pre_flight_checks": {
    "checks": [
      {
        "id": "pf-git-clean",
        "description": "Repo has no uncommitted changes in target paths.",
        "when": "always",
        "command": {
          "tool_id": "powershell-script",
          "args": [
            "git status --porcelain"
          ]
        },
        "success_pattern": "^$",
        "on_fail": "abort"
      },
      {
        "id": "pf-venv-present",
        "description": "Python virtual env exists.",
        "when": "always",
        "command": {
          "tool_id": "powershell-script",
          "args": [
            "Test-Path .venv"
          ]
        },
        "success_pattern": "True",
        "on_fail": "attempt_repair_phase"
      },
      {
        "id": "pf-state-db-schema",
        "description": "State DB schema file exists where expected (if required for this phase).",
        "when": "if_phase_type_in:[implementation,integration,migration]",
        "command": {
          "tool_id": "powershell-script",
          "args": [
            "Test-Path schema/pipeline_state.sql"
          ]
        },
        "success_pattern": "True",
        "on_fail": "abort"
      }
    ]
  },
  "execution_plan": {
    "steps": [
      {
        "id": "step-01-analyze-context",
        "name": "Analyze current repo and specs",
        "operation_kind": "OP-ANALYZE-CONTEXT",
        "pattern_ids": [
          "PAT-ANALYZE-REPO-001"
        ],
        "description": "Scan relevant modules, docs, and config to understand the current state.",
        "tool_id": "codex",
        "inputs": {
          "repo_paths": [
            "src/pipeline/**",
            "docs/spec/**",
            "schema/**"
          ],
          "constraints": {
            "respect_file_scope": true
          },
          "execution_templates": []
        },
        "expected_outputs": [
          "Refined internal plan for changes (not persisted)."
        ],
        "requires_human_confirmation": false
      },
      {
        "id": "step-02-implement-changes",
        "name": "Apply scoped edits in isolated worktree",
        "operation_kind": "OP-EDIT-IMPLEMENT",
        "pattern_ids": [
          "PAT-EDIT-WORKTREE-001",
          "PAT-FILE-SCOPE-ENFORCE-001"
        ],
        "description": "Use Aider/Codex to implement changes within declared file_scope in a dedicated worktree.",
        "tool_id": "aider-edit",
        "inputs": {
          "worktree_strategy_ref": "worktree_strategy",
          "file_scope_ref": "scope_and_modules.file_scope.modify",
          "execution_templates": []
        },
        "expected_outputs": [
          "Worktree with candidate implementation."
        ],
        "requires_human_confirmation": false
      },
      {
        "id": "step-03-static-checks",
        "name": "Run static validation tools",
        "operation_kind": "OP-VALIDATE-STATIC",
        "pattern_ids": [
          "PAT-LINT-001",
          "PAT-TYPECHECK-001"
        ],
        "description": "Run ruff, mypy, and other static tools via tool_profiles.",
        "tool_id": "pytest",
        "inputs": {
          "commands": [
            "ruff src/pipeline tests/pipeline",
            "mypy src/pipeline"
          ],
          "execution_templates": []
        },
        "expected_outputs": [
          "All static tools pass or produce structured error output."
        ],
        "requires_human_confirmation": false
      },
      {
        "id": "step-04-runtime-tests",
        "name": "Run runtime tests",
        "operation_kind": "OP-VALIDATE-RUNTIME",
        "pattern_ids": [
          "PAT-PYTEST-CORE-001"
        ],
        "description": "Run pytest suite for modules touched by this phase.",
        "tool_id": "pytest",
        "inputs": {
          "commands": [
            "pytest tests/pipeline -q"
          ]
        },
        "expected_outputs": [
          "All relevant tests pass."
        ],
        "requires_human_confirmation": false
      }
    ]
  },
  "fix_loop_and_circuit_breakers": {
    "enabled": true,
    "applies_to_steps": [
      "step-03-static-checks",
      "step-04-runtime-tests"
    ],
    "circuit_breaker_config_ref": "config/circuit_breakers.yaml",
    "defaults": {
      "max_attempts": 3,
      "oscillation_window": 3,
      "oscillation_threshold": 2
    },
    "behavior": {
      "on_first_failure": "invoke_fix_pattern",
      "on_subsequent_failure": "re-run-base-step",
      "on_breaker_trip": "mark_phase_failed"
    }
  },
  "expected_artifacts": {
    "patches": [
      {
        "path": ".ledger/patches/${phase_id}_${workstream_id}.patch",
        "must_exist": true
      }
    ],
    "logs": [
      {
        "path": ".runs/${workstream_id}/${phase_id}/static_checks.log",
        "must_exist": true
      },
      {
        "path": ".runs/${workstream_id}/${phase_id}/runtime_tests.log",
        "must_exist": true
      }
    ],
    "docs": [
      {
        "path": "docs/state/state_machine.md",
        "must_exist": true
      },
      {
        "path": "docs/architecture/PHASE_PLAN.md",
        "must_exist": true
      }
    ],
    "db": {
      "migrations_applied": [
        "schema/migrations/00_create_state_tables.sql"
      ]
    }
  },
  "acceptance_tests": {
    "tests": [
      {
        "id": "acc-01-pipeline-smoke",
        "description": "Pipeline CLI can run a no-op workstream successfully.",
        "command": {
          "tool_id": "powershell-script",
          "args": [
            "python scripts/run_workstream.py --ws-id ${workstream_id} --dry-run"
          ]
        },
        "success_pattern": "STATUS: SUCCESS",
        "must_pass": true
      },
      {
        "id": "acc-02-db-state-transitions",
        "description": "State machine refuses invalid transitions.",
        "command": {
          "tool_id": "pytest",
          "args": [
            "pytest tests/pipeline/test_db_state.py -q"
          ]
        },
        "success_pattern": "0 failed",
        "must_pass": true
      }
    ]
  },
  "completion_gate": {
    "rules": {
      "dependencies_done": true,
      "pre_flight_passed": true,
      "acceptance_tests_all_passed": true,
      "required_artifacts_present": true,
      "no_scope_violations_detected": true,
      "circuit_breakers_not_tripped": true
    },
    "manual_override": {
      "allowed": false,
      "justification_required": true
    }
  },
  "observability_and_metrics": {
    "event_tags": [
      "phase:${phase_identity.phase_id}",
      "workstream:${phase_identity.workstream_id}",
      "phase_type:${phase_identity.phase_type}"
    ],
    "metrics": {
      "record_durations": true,
      "record_attempt_counts": true,
      "record_fix_loop_stats": true
    }
  },
  "governance_and_constraints": {
    "anti_patterns_blocked": [
      "ANTI-GIANT-REFRACTOR-001",
      "ANTI-EDIT-OUTSIDE-SCOPE-001",
      "ANTI-SKIP-TESTS-001"
    ],
    "notes_for_operators": [
      "Never modify files outside declared file_scope.",
      "Always trust git/tests/filesystem over conversational summaries.",
      "If tools under-deliver, repair or escalate\u00e2\u20ac\u201ddo not silently accept."
    ]
  },
  "extensions": {
    "custom_fields": {
      "workstream_sync": {
        "enabled": true,
        "auto_commit": true,
        "feature_branch_pattern": "feature/ws-sync-${timestamp}",
        "github_project_integration": true,
        "no_stop_mode": true,
        "summary_report_template": "templates/workstream_summary_report.md",
        "sync_script": "scripts/sync_workstreams_to_github.py"
      },
      "execution_resilience": {
        "continue_on_error": true,
        "error_collection_mode": true,
        "final_report_on_completion": true
      }
    }
  }
}
