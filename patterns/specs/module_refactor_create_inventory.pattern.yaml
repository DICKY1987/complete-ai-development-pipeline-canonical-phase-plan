doc_id: DOC-PAT-MODULE-REFACTOR-CREATE-INVENTORY-PATTERN-051
pattern_id: PAT-MODULE-REFACTOR-INVENTORY-002
name: module_refactor_create_inventory
version: 1.0.0
status: active
category: module_refactor
operation_kind: DEFINE_MODULE_STRUCTURE

metadata:
  created: "2025-11-28"
  author: "Module Refactor Team"
  purpose: "Define canonical module inventory and dependency graph"
  time_savings_vs_manual: "90%"
  proven_uses: 0

summary: |
  Create MODULES_INVENTORY.yaml defining all target modules, their kinds, purposes,
  and dependencies. This becomes the authoritative source of truth for the refactor.

description: |
  This pattern generates the foundational governance document that defines:
  - All module IDs in the system
  - Module kinds (PIPELINE_STAGE, FEATURE_SERVICE, etc.)
  - Module descriptions and responsibilities
  - Dependency relationships (critical for migration ordering)
  - Legacy path hints (where current content lives)

  The inventory ensures all tooling and AI agents have a consistent understanding
  of the target architecture.

inputs:
  - name: output_path
    type: path
    required: false
    description: "Path for module inventory file"
    default: "modules/MODULES_INVENTORY.yaml"

  - name: include_dependencies
    type: boolean
    required: false
    description: "Include dependency graph in inventory"
    default: true

  - name: validate_against_dataflows
    type: boolean
    required: false
    description: "Validate modules against DATA_FLOWS.md"
    default: true

outputs:
  - name: inventory_file
    type: path
    description: "Generated module inventory"

  - name: dependency_graph_file
    type: path
    description: "Separate dependency graph if requested"
    default: "modules/MODULE_DEPENDENCIES.yaml"

module_definitions:
  pipeline_stage_modules:
    - module_id: intake_spec
      module_kind: PIPELINE_STAGE_MODULE
      description: "OpenSpec + CCPM → workstreams conversion and validation"
      responsibilities:
        - "Parse OpenSpec files"
        - "Validate against schemas"
        - "Convert to workstream JSON"
        - "Link to CCPM issues"
      legacy_paths:
        - "openspec/"
        - "specifications/"
        - "workstreams/"
      depends_on: []

    - module_id: planning
      module_kind: PIPELINE_STAGE_MODULE
      description: "Decompose workstreams into tasks and build DAG"
      responsibilities:
        - "Break workstreams into atomic tasks"
        - "Build dependency graph (DAG)"
        - "Apply planning rules and patterns"
      legacy_paths:
        - "core/planner/"
        - "engine/planning/"
      depends_on:
        - intake_spec
        - patterns_engine

    - module_id: scheduling
      module_kind: PIPELINE_STAGE_MODULE
      description: "Resolve dependencies, manage concurrency and task queues"
      responsibilities:
        - "Resolve task dependencies"
        - "Determine parallel execution opportunities"
        - "Queue tasks with priorities"
      legacy_paths:
        - "core/scheduler/"
        - "engine/queue/"
      depends_on:
        - planning
        - state_lifecycle

    - module_id: execution
      module_kind: PIPELINE_STAGE_MODULE
      description: "Execute tasks via tool adapters with monitoring"
      responsibilities:
        - "Pull tasks from queue"
        - "Invoke tool adapters"
        - "Stream execution output"
        - "Run acceptance tests"
      legacy_paths:
        - "core/executor/"
        - "engine/orchestrator/"
        - "engine/adapters/"
      depends_on:
        - scheduling
        - aim_tools
        - state_lifecycle

    - module_id: error_recovery
      module_kind: PIPELINE_STAGE_MODULE
      description: "Capture, classify, and auto-fix errors with escalation"
      responsibilities:
        - "Capture execution errors"
        - "Run error detection plugins"
        - "Classify severity"
        - "Auto-fix or escalate"
      legacy_paths:
        - "error/engine/"
        - "error/plugins/"
      depends_on:
        - execution
        - patterns_engine
        - state_lifecycle

    - module_id: state_lifecycle
      module_kind: PIPELINE_STAGE_MODULE
      description: "Track runs, tasks, and file lifecycles in SQLite"
      responsibilities:
        - "Maintain run/workstream/task state"
        - "File lifecycle state machine"
        - "Persist to SQLite"
        - "State transition validation"
      legacy_paths:
        - "state/"
        - "core/state/"
      depends_on: []

    - module_id: reporting
      module_kind: PIPELINE_STAGE_MODULE
      description: "Generate execution reports, summaries, and dashboards"
      responsibilities:
        - "Execution reports"
        - "Progress summaries"
        - "Historical analysis"
        - "Archive completed work"
      legacy_paths:
        - "reports/"
        - "gui/reports/"
      depends_on:
        - state_lifecycle
        - error_recovery

  feature_service_modules:
    - module_id: aim_tools
      module_kind: FEATURE_SERVICE_MODULE
      description: "Tool registry, profiles, selection logic, and health monitoring"
      responsibilities:
        - "Maintain tool registry"
        - "Tool profile management"
        - "Selection decision tree"
        - "Tool health metrics"
      legacy_paths:
        - "aim/"
        - "config/tool_profiles.*"
      depends_on:
        - registry_core

    - module_id: patterns_engine
      module_kind: FEATURE_SERVICE_MODULE
      description: "UET patterns, pattern doc suites, and execution templates"
      responsibilities:
        - "Pattern registry"
        - "Pattern doc suite management"
        - "UET execution templates"
        - "Operation kind resolution"
      legacy_paths:
        - "UNIVERSAL_EXECUTION_TEMPLATES_FRAMEWORK/"
        - "templates/"
      depends_on:
        - registry_core

    - module_id: spec_bridge
      module_kind: FEATURE_SERVICE_MODULE
      description: "Bridge OpenSpec, CCPM, and phase plans to internal formats"
      responsibilities:
        - "OpenSpec URI resolution"
        - "CCPM integration"
        - "Phase plan import"
        - "Cross-reference management"
      legacy_paths:
        - "openspec/"
        - "ccpm/"
        - "pm/"
      depends_on:
        - registry_core

    - module_id: registry_core
      module_kind: REGISTRY_METADATA_MODULE
      description: "Central ID registry and artifact tracking"
      responsibilities:
        - "doc_id/pattern_id/module_id registry"
        - "Artifact metadata"
        - "Version tracking"
        - "Cross-reference resolution"
      legacy_paths:
        - "registry/"
        - "doc_id/"
      depends_on: []

  interface_modules:
    - module_id: gui_shell
      module_kind: INTERFACE_MODULE
      description: "GUI/TUI/CLI interfaces over the execution engine"
      responsibilities:
        - "Visual dashboards"
        - "Interactive task display"
        - "Progress visualization"
        - "User interaction layer"
      legacy_paths:
        - "gui/"
        - "tui_app/"
      depends_on:
        - state_lifecycle
        - reporting
        - patterns_engine

execution_steps:
  - step: 1
    operation_kind: CREATE_OUTPUT_DIR
    description: "Ensure modules/ directory exists"
    script: |
      import pathlib
      pathlib.Path("modules").mkdir(exist_ok=True)

  - step: 2
    operation_kind: SAVE_FILE
    description: "Write MODULES_INVENTORY.yaml"
    path: "{{output_path}}"
    content_template: |
      # MODULES_INVENTORY.yaml
      # Version: 1.0.0
      # Created: {{timestamp}}
      # Purpose: Canonical registry of all modules in the system

      version: 1.0.0
      created: "{{timestamp}}"
      total_modules: {{total_module_count}}

      pipeline_stage_modules:
      {{#pipeline_stage_modules}}
        - module_id: {{module_id}}
          module_kind: {{module_kind}}
          description: "{{description}}"
          responsibilities: {{responsibilities}}
          legacy_paths: {{legacy_paths}}
          depends_on: {{depends_on}}
      {{/pipeline_stage_modules}}

      feature_service_modules:
      {{#feature_service_modules}}
        - module_id: {{module_id}}
          module_kind: {{module_kind}}
          description: "{{description}}"
          responsibilities: {{responsibilities}}
          legacy_paths: {{legacy_paths}}
          depends_on: {{depends_on}}
      {{/feature_service_modules}}

      interface_modules:
      {{#interface_modules}}
        - module_id: {{module_id}}
          module_kind: {{module_kind}}
          description: "{{description}}"
          responsibilities: {{responsibilities}}
          legacy_paths: {{legacy_paths}}
          depends_on: {{depends_on}}
      {{/interface_modules}}

  - step: 3
    operation_kind: SAVE_FILE
    description: "Write MODULE_DEPENDENCIES.yaml"
    condition: "{{include_dependencies}}"
    path: "modules/MODULE_DEPENDENCIES.yaml"
    content_template: |
      # MODULE_DEPENDENCIES.yaml
      # Dependency graph for module migration ordering

      version: 1.0.0
      created: "{{timestamp}}"

      # Modules with NO dependencies (migrate first)
      independent_modules:
        - registry_core
        - state_lifecycle
        - spec_bridge

      # Modules with dependencies (migrate in order)
      dependent_modules:
        intake_spec:
          depends_on: [registry_core]
        planning:
          depends_on: [intake_spec, patterns_engine]
        scheduling:
          depends_on: [planning, state_lifecycle]
        aim_tools:
          depends_on: [registry_core]
        patterns_engine:
          depends_on: [registry_core]
        execution:
          depends_on: [scheduling, aim_tools, state_lifecycle]
        error_recovery:
          depends_on: [execution, patterns_engine, state_lifecycle]
        reporting:
          depends_on: [state_lifecycle, error_recovery]
        gui_shell:
          depends_on: [state_lifecycle, reporting, patterns_engine]

      # Recommended migration order (topological sort)
      migration_order:
        phase_1:
          - registry_core
          - state_lifecycle
        phase_2:
          - spec_bridge
          - patterns_engine
          - aim_tools
        phase_3:
          - intake_spec
          - planning
        phase_4:
          - scheduling
          - execution
        phase_5:
          - error_recovery
          - reporting
        phase_6:
          - gui_shell

validation_gates:
  - gate: inventory_created
    description: "Inventory file exists"
    check_type: file_exists
    path: "{{output_path}}"

  - gate: valid_yaml
    description: "Inventory is valid YAML"
    check_type: yaml_valid
    path: "{{output_path}}"

  - gate: all_modules_defined
    description: "All expected module_ids present"
    check_type: yaml_contains_keys
    path: "{{output_path}}"
    required_keys:
      - pipeline_stage_modules
      - feature_service_modules
      - interface_modules

success_criteria:
  - "MODULES_INVENTORY.yaml created"
  - "All module_ids defined with kinds"
  - "Dependency graph complete"
  - "Legacy path hints provided"

tool_targets:
  - claude_code
  - github_copilot_cli
  - cursor

tags:
  - module_refactor
  - governance
  - inventory
  - architecture

dependencies:
  patterns: []
  scripts: []

notes: |
  This inventory becomes the single source of truth for:
  - Module boundaries
  - Migration ordering (via dependency graph)
  - Legacy path → module mapping
  - Module kind classification

  Update this file BEFORE starting any physical file migrations.
