# Pattern: docid_phase0_completion
# Pattern ID: PAT-DOCID-PHASE0-COMPLETION-001
# doc_id: DOC-PAT-DOCID-PHASE0-COMPLETION-001
# Version: 1.0.0
# Category: sequential

doc_id: "DOC-PAT-DOCID-PHASE0-COMPLETION-001"
pattern_id: "PAT-DOCID-PHASE0-COMPLETION-001"
name: "docid_phase0_completion"
version: "1.0.0"
category: "sequential"
status: "active"
role: "spec"

metadata:
  created: "2025-11-30"
  author: "AI Agent"
  purpose: "Complete Phase 0 doc_id universal coverage"
  related_docs:
    - "doc_id/COMPLETE_PHASE_PLAN.md"
    - "doc_id/DEVELOPMENT_ROADMAP.md"
    - "doc_id/QUICK_START_CHECKLIST.md"

intent: |
  Execute Phase 0 of doc_id system to achieve 100% coverage across all eligible files.
  Uses automated scanning and assignment to process ~2,170 remaining files in batches.
  
  This pattern orchestrates the complete Phase 0 workflow from current state (25% coverage)
  to final state (100% coverage) through systematic batch processing.

preconditions:
  - name: "Scanner and Assigner tools exist"
    check: "Test-Path scripts/doc_id_scanner.py -and (Test-Path scripts/doc_id_assigner.py)"
    
  - name: "On feature branch"
    check: "git branch --show-current | Select-String 'feature/phase0-docid-assignment'"
    
  - name: "Registry is valid"
    check: "python doc_id/tools/doc_id_registry_cli.py validate"
    
  - name: "Current coverage < 100%"
    check: "python scripts/doc_id_scanner.py stats | Select-String 'Files missing doc_id:.*[1-9]'"

inputs:
  batch_size:
    type: "integer"
    default: 200
    description: "Number of files to process per batch"
    
  file_types:
    type: "array"
    default: ["py", "md", "sh", "txt"]
    description: "File types to process in order"
    
  dry_run:
    type: "boolean"
    default: false
    description: "If true, preview changes without applying"

steps:
  - id: "step_1_fix_sanitization"
    name: "Fix Name Sanitization"
    action: "edit"
    description: "Improve sanitization for edge cases"
    files:
      - path: "scripts/doc_id_assigner.py"
        changes:
          - location: "line 175-185"
            action: "replace"
            old_pattern: "def sanitize_name.*"
            new_content: |
              def sanitize_name(name: str) -> str:
                  # Remove leading special chars
                  name = re.sub(r'^[^A-Za-z0-9]+', '', name)
                  # Replace special chars with dashes
                  name = re.sub(r'[^A-Za-z0-9-]+', '-', name)
                  # Collapse multiple dashes
                  name = re.sub(r'-+', '-', name)
                  # Remove trailing dashes
                  name = name.strip('-')
                  # Limit length
                  return name[:40].upper()
    validation:
      command: "python -m py_compile scripts/doc_id_assigner.py"
      
  - id: "step_2_python_batch1"
    name: "Assign Python Files - Batch 1"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types py --limit {batch_size} --report reports/batch_py_1.json"
    depends_on: ["step_1_fix_sanitization"]
    validation:
      command: "Test-Path reports/batch_py_1.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Python batch 1 (200 files)'"
      
  - id: "step_3_python_batch2"
    name: "Assign Python Files - Batch 2"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types py --limit {batch_size} --report reports/batch_py_2.json"
    depends_on: ["step_2_python_batch1"]
    validation:
      command: "Test-Path reports/batch_py_2.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Python batch 2 (200 files)'"
      
  - id: "step_4_python_batch3"
    name: "Assign Python Files - Batch 3"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types py --limit {batch_size} --report reports/batch_py_3.json"
    depends_on: ["step_3_python_batch2"]
    validation:
      command: "Test-Path reports/batch_py_3.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Python batch 3 (200 files)'"
      
  - id: "step_5_python_batch4"
    name: "Assign Python Files - Batch 4"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types py --limit {batch_size} --report reports/batch_py_4.json"
    depends_on: ["step_4_python_batch3"]
    validation:
      command: "Test-Path reports/batch_py_4.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Python batch 4 (200 files)'"
      
  - id: "step_6_python_final"
    name: "Assign Python Files - Final"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types py --report reports/batch_py_final.json"
    depends_on: ["step_5_python_batch4"]
    validation:
      command: "Test-Path reports/batch_py_final.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Python final batch'"
      
  - id: "step_7_markdown_batch1"
    name: "Assign Markdown Files - Batch 1"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types md --limit 250 --report reports/batch_md_1.json"
    depends_on: ["step_6_python_final"]
    validation:
      command: "Test-Path reports/batch_md_1.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Markdown batch 1 (250 files)'"
      
  - id: "step_8_markdown_batch2"
    name: "Assign Markdown Files - Batch 2"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types md --limit 250 --report reports/batch_md_2.json"
    depends_on: ["step_7_markdown_batch1"]
    validation:
      command: "Test-Path reports/batch_md_2.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Markdown batch 2 (250 files)'"
      
  - id: "step_9_markdown_batch3"
    name: "Assign Markdown Files - Batch 3"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types md --limit 250 --report reports/batch_md_3.json"
    depends_on: ["step_8_markdown_batch2"]
    validation:
      command: "Test-Path reports/batch_md_3.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Markdown batch 3 (250 files)'"
      
  - id: "step_10_markdown_batch4"
    name: "Assign Markdown Files - Batch 4"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types md --limit 250 --report reports/batch_md_4.json"
    depends_on: ["step_9_markdown_batch3"]
    validation:
      command: "Test-Path reports/batch_md_4.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Markdown batch 4 (250 files)'"
      
  - id: "step_11_markdown_final"
    name: "Assign Markdown Files - Final"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types md --report reports/batch_md_final.json"
    depends_on: ["step_10_markdown_batch4"]
    validation:
      command: "Test-Path reports/batch_md_final.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Markdown final batch'"
      
  - id: "step_12_shell_text"
    name: "Assign Shell and Text Files"
    action: "execute"
    command: "python scripts/doc_id_assigner.py auto-assign --types sh txt --report reports/batch_sh_txt_final.json"
    depends_on: ["step_11_markdown_final"]
    validation:
      command: "Test-Path reports/batch_sh_txt_final.json"
    post_action:
      - "git add ."
      - "git commit -m 'chore: Phase 0 - Shell and Text files'"
      
  - id: "step_13_final_validation"
    name: "Final Validation"
    action: "validate"
    depends_on: ["step_12_shell_text"]
    checks:
      - name: "Full scan"
        command: "python scripts/doc_id_scanner.py scan"
      - name: "Verify 100% coverage"
        command: "python scripts/doc_id_scanner.py stats"
        expected: "Files with doc_id:.*100\\.0%"
      - name: "Validate registry"
        command: "python doc_id/tools/doc_id_registry_cli.py validate"
        expected: "No errors"
    post_action:
      - "python scripts/doc_id_scanner.py scan > reports/final_coverage_report.txt"
      - "python doc_id/tools/doc_id_registry_cli.py stats > reports/final_registry_stats.txt"
      
  - id: "step_14_merge_to_main"
    name: "Merge to Main"
    action: "git_merge"
    depends_on: ["step_13_final_validation"]
    steps:
      - "git add ."
      - "git commit -m 'chore: Phase 0 complete - 100% doc_id coverage

- Total files assigned: 2,726 new doc_ids
- Coverage: 5.6% → 100%
- Registry: 274 → ~3,160 docs
- All eligible file types covered
- Tools: scanner + auto-assigner operational
- Ready for production use'"
      - "git checkout main"
      - "git merge feature/phase0-docid-assignment --no-ff"
      - "git push origin main"
      - "git tag -a v1.0.0-docid-phase0 -m 'Phase 0: Universal doc_id coverage achieved'"
      - "git push origin v1.0.0-docid-phase0"

postconditions:
  - name: "100% coverage achieved"
    check: "python scripts/doc_id_scanner.py stats | Select-String 'Files with doc_id:.*2894.*100\\.0%'"
    
  - name: "Registry validates"
    check: "python doc_id/tools/doc_id_registry_cli.py validate"
    
  - name: "On main branch"
    check: "git branch --show-current | Select-String '^main$'"
    
  - name: "Release tagged"
    check: "git tag -l | Select-String 'v1.0.0-docid-phase0'"

outputs:
  coverage_report:
    path: "reports/final_coverage_report.txt"
    description: "Final coverage statistics"
    
  registry_stats:
    path: "reports/final_registry_stats.txt"
    description: "Final registry statistics"
    
  batch_reports:
    path: "reports/batch_*.json"
    description: "Individual batch execution reports"

rollback:
  description: "Rollback to backup branch if issues occur"
  steps:
    - "git checkout main"
    - "git reset --hard backup-before-docid-assignment"
    - "git push origin main --force"

estimated_time: "3 hours"
estimated_commits: "11-12 commits"
estimated_registry_growth: "274 → 3160 docs (+2886)"
