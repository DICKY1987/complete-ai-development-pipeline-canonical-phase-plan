# Engine Layer Dependencies
# Module: core.engine
# Purpose: Orchestration and execution dependencies
# Last Updated: 2025-11-23

metadata:
  module: core.engine
  description: Workstream orchestration, scheduling, execution, and tool integration
  layer: domain
  status: production

# Internal dependencies (within core.engine)
internal_dependencies:
  within_engine:
    - orchestrator.py depends on scheduler.py, executor.py
    - executor.py depends on tools.py, circuit_breakers.py
    - recovery_manager.py depends on recovery.py
    - All depend on adapters.base for tool integration
  
  from_other_core_modules:
    - core.state:
        imports:
          - from core.state.db import init_db, get_connection
          - from core.state.crud import create_workstream, record_step_attempt
          - from core.state.bundles import load_and_validate_bundles
        
        purpose: State persistence and bundle management

# External Python dependencies
external_dependencies:
  required:
    - name: PyYAML
      version: ">=6.0"
      purpose: Parse circuit breaker and tool configuration
      used_by:
        - circuit_breakers.py
        - tools.py
    
    - name: typing
      version: Built-in
      purpose: Type hints
      used_by:
        - All modules
    
    - name: subprocess
      version: Built-in
      purpose: Execute external tool binaries
      used_by:
        - adapters/aider_adapter.py
        - adapters/claude_adapter.py
        - adapters/codex_adapter.py
    
    - name: concurrent.futures
      version: Built-in
      purpose: Parallel execution with worker pools
      used_by:
        - orchestrator.py
        - worker.py
  
  optional:
    - name: rich
      version: ">=13.0.0"
      purpose: Terminal progress display
      used_by:
        - orchestrator.py (progress bars)
        - metrics.py (rich tables)

# System dependencies
system_dependencies:
  optional:
    - name: aider
      version: ">=0.20.0"
      purpose: AI code editing tool
      used_by:
        - adapters/aider_adapter.py
      
      installation: pip install aider-chat
      fallback: Other tools via AIM routing
    
    - name: claude
      purpose: Claude CLI tool
      used_by:
        - adapters/claude_adapter.py
      
      installation: npm install -g @anthropic-ai/claude-cli
      fallback: API-based adapter

# Configuration file dependencies
config_dependencies:
  - path: config/tool_profiles.json
    purpose: Tool adapter configurations
    used_by:
      - tools.py
      - adapters/*.py
    
    structure:
      tool_id:
        binary: str
        args: list[str]
        env: dict[str, str]
        timeout_sec: int
    
    example: |
      {
        "aider": {
          "binary": "aider",
          "args": ["--yes", "--no-auto-commits"],
          "env": {"AIDER_NO_GIT": "1"},
          "timeout_sec": 300
        }
      }
  
  - path: config/circuit_breaker_config.yaml
    purpose: Circuit breaker thresholds
    used_by:
      - circuit_breakers.py
      - orchestrator.py
    
    structure:
      max_fix_iterations:
        static: int
        runtime: int
      oscillation_window: int
      min_oscillation_repeats: int
      timeouts:
        edit: int
        static: int
        runtime: int
        fix: int

# Cross-module dependencies
cross_module_dependencies:
  depends_on:
    - module: core.state
      services:
        - Database operations
        - Bundle loading
        - State tracking
      
      critical: true
      fallback: null
    
    - module: aim
      services:
        - Capability-based tool routing
        - Tool registry
      
      critical: false
      fallback: Direct tool invocation via profiles
      used_by:
        - aim_integration.py
  
  provides_to:
    - module: engine
      services:
        - Orchestration API
        - Tool adapters
    
    - module: pm
      services:
        - Workstream execution

# Environment variables
environment_variables:
  required: []
  
  optional:
    - name: PIPELINE_DRY_RUN
      default: "0"
      purpose: Skip actual tool invocations (testing)
      used_by:
        - orchestrator.py
        - executor.py
        - adapters/*.py
      
      values:
        - "0": Normal execution
        - "1": Dry run mode
    
    - name: PIPELINE_MAX_WORKERS
      default: "4"
      purpose: Maximum parallel workers
      used_by:
        - orchestrator.py
        - worker.py
      
      validation: Must be positive integer
    
    - name: PIPELINE_TIMEOUT_SEC
      default: "3600"
      purpose: Global execution timeout
      used_by:
        - executor.py
        - adapters/*.py
      
      validation: Must be positive integer
    
    - name: AIM_REGISTRY_PATH
      default: null
      purpose: AIM registry location (auto-detected)
      used_by:
        - aim_integration.py
    
    - name: OPENAI_API_KEY
      default: null
      purpose: OpenAI API authentication
      used_by:
        - adapters/codex_adapter.py
      
      critical: false
      fallback: Adapter not available
    
    - name: ANTHROPIC_API_KEY
      default: null
      purpose: Anthropic API authentication
      used_by:
        - adapters/claude_adapter.py
      
      critical: false
      fallback: Adapter not available

# Tool binary dependencies
tool_dependencies:
  # Tools are optional - system degrades gracefully
  optional:
    - binary: aider
      adapter: adapters/aider_adapter.py
      check_command: aider --version
      installation: pip install aider-chat
    
    - binary: claude
      adapter: adapters/claude_adapter.py
      check_command: claude --version
      installation: npm install -g @anthropic-ai/claude-cli

# Public API exports
public_api:
  orchestrator.py:
    - run_workstream()
    - execute_workstreams_parallel()
    - run_edit_step()
    - run_static_step()
    - run_runtime_step()
  
  scheduler.py:
    - build_execution_plan()
  
  tools.py:
    - run_tool()
    - load_tool_profiles()
  
  adapters:
    - get_adapter()
    - list_adapters()
    - BaseAdapter (interface)

# Consumed by
consumed_by:
  - module: engine
    imports:
      - from core.engine.orchestrator import run_workstream
    
    usage:
      - Job-based execution wrapper
  
  - module: scripts
    imports:
      - from core.engine.orchestrator import execute_workstreams_parallel
    
    usage:
      - Automation scripts
  
  - CLI tools:
      - core.ui_cli.py
      - core.ui_settings_cli.py

# Adapter interface specification
adapter_interface:
  required_methods:
    - execute(prompt, files, context) -> dict
    - validate_config() -> bool
  
  optional_methods:
    - get_capabilities() -> dict
  
  result_structure:
    success: bool
    exit_code: int
    stdout: str
    stderr: str
    files_modified: list[str]
    elapsed_sec: float
    error: str (if success=False)

# Performance characteristics
performance:
  orchestration:
    - Scheduling: O(n log n) for topological sort
    - Parallel execution: Linear speedup up to max_workers
    - Wave coordination: Sequential waves, parallel within wave
  
  circuit_breakers:
    - Check: O(1) per iteration
    - Oscillation detection: O(w) for window size w
  
  tool_invocation:
    - Subprocess overhead: ~50ms per invocation
    - Timeout handling: Precise to 1 second

# Testing requirements
testing:
  unit_tests:
    - tests/orchestrator/test_orchestrator.py
    - tests/orchestrator/test_scheduler.py
    - tests/orchestrator/test_executor.py
    - tests/orchestrator/test_circuit_breakers.py
    - tests/adapters/test_*_adapter.py
  
  integration_tests:
    - tests/integration/test_parallel_execution.py
    - tests/integration/test_full_pipeline.py
  
  mock_requirements:
    - Mock tool binaries for unit tests
    - Use PIPELINE_DRY_RUN=1 for integration tests
  
  coverage_target: ">85%"

# Constraints and invariants
constraints:
  - rule: Adapters must implement BaseAdapter interface
    enforcement: Code review + type checking
    rationale: Consistent tool integration
  
  - rule: Circuit breakers must prevent infinite loops
    enforcement: Unit tests + runtime checks
    rationale: System reliability
  
  - rule: Timeouts must be configurable
    enforcement: Code review
    rationale: Different environments have different needs
  
  - rule: State changes must be recorded via core.state
    enforcement: Code review
    rationale: Audit trail and persistence
  
  - rule: Failed tools must not crash orchestrator
    enforcement: Exception handling + tests
    rationale: Graceful degradation

# Error handling strategy
error_handling:
  - Tool execution failure:
      strategy: Retry with exponential backoff
      max_retries: 3
      fallback: Alternative tool via AIM
  
  - Timeout:
      strategy: Terminate process, record failure
      cleanup: Kill process group
      state: Mark step as failed
  
  - Circuit breaker trip:
      strategy: Stop FIX loop, mark as failed
      notification: Log warning + event
      recovery: Manual intervention or skip
  
  - Configuration error:
      strategy: Validate on startup, fail fast
      recovery: Fix configuration file

# Migration notes
migration_notes:
  legacy_paths:
    - from: src.pipeline.orchestrator
      to: core.engine.orchestrator
      status: deprecated
    
    - from: src.pipeline.tools
      to: core.engine.tools
      status: deprecated
  
  breaking_changes:
    - v2.0.0: Adapter interface added get_capabilities()
    - v2.1.0: Removed synchronous orchestrator API

# Notes for AI tools
ai_notes:
  - Always set timeouts to prevent hanging
  - Use circuit breakers to prevent infinite loops
  - Monitor metrics for execution tracking
  - Respect conflict groups in parallel execution
  - Validate tool availability before execution
  - Record all state transitions via core.state
