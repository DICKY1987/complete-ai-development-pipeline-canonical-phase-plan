module: "core.state"
purpose: "State management: SQLite database for runs, steps, events, persistence"
layer: "infra"

entry_points:
  - file: "db.py"
    function: "init_db()"
    description: "Initialize database schema, create tables if not exist"

  - file: "db.py"
    function: "get_db_path()"
    description: "Resolve database path: ENV > arg > default (.worktrees/pipeline_state.db)"

key_patterns:
  - "Database path resolution: os.getenv('UET_DB_PATH') > db_path arg > '.worktrees/pipeline_state.db'"
  - "Schema auto-created on first init_db() call"
  - "Use context manager for sessions: with get_session() as session:"
  - "Migrations in schema/migrations/ (manual SQL files)"

common_tasks:
  - task: "Initialize database"
    code: |
      from core.state.db import init_db
      init_db(db_path=".worktrees/pipeline_state.db")
    approach: "Call init_db() with optional custom path"

  - task: "Query run records"
    code: |
      from core.state.db import get_session
      with get_session(db_path) as session:
          # Query database using SQLAlchemy
          results = session.execute("SELECT * FROM runs")
    approach: "Use SQLAlchemy session for database queries"

  - task: "Custom database path"
    code: |
      export UET_DB_PATH=/custom/path/state.db
      # Or pass to init_db(db_path=...)
    approach: "Set ENV var or pass argument"

gotchas:
  - "Database path defaults to .worktrees/pipeline_state.db (may not exist in base repo)"
  - "init_db() is idempotent - safe to call multiple times"
  - "Schema migrations are MANUAL - no automatic migration tool yet"
  - "Session management: always use context manager to avoid leaks"
  - "SQLite is single-writer - don't share db file across processes"

dependencies:
  external:
    - "sqlalchemy"
    - "sqlite3 (Python stdlib)"
  internal: []

status:
  maturity: "stable"
  test_coverage: "95%"
  production_ready: true
  breaking_changes_expected: false

ai_quick_reference:
  init: "init_db(db_path)"
  get_path: "db_path = get_db_path(custom_path)"
  session: "with get_session(db_path) as session: ..."
