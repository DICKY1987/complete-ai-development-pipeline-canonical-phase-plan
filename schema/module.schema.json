{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ai-pipeline.dev/schemas/module.v1.json",
  "title": "AI Module Manifest Schema",
  "description": "Schema for module manifests in AI-oriented, module-centric codebase architecture. Enables deterministic context loading, atomic module boundaries, and ULID-based identity.",
  "type": "object",
  "required": [
    "module_id",
    "ulid_prefix",
    "purpose",
    "layer"
  ],
  "properties": {
    "module_id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Unique module identifier (kebab-case). Examples: 'core-state', 'error-plugin-ruff', 'specifications-tools'",
      "examples": [
        "core-state",
        "error-engine",
        "aim-registry"
      ]
    },
    "ulid_prefix": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{6}$",
      "description": "ULID prefix (first 6 chars) shared by all artifacts in this module. Enables machine-verifiable relationships.",
      "examples": [
        "01JDEX",
        "01JDEY",
        "01JDEZ"
      ]
    },
    "purpose": {
      "type": "string",
      "maxLength": 200,
      "description": "Concise statement of module purpose (for AI context loading)",
      "examples": [
        "Database operations and state management",
        "Error detection engine with plugin orchestration"
      ]
    },
    "layer": {
      "type": "string",
      "enum": [
        "infra",
        "domain",
        "api",
        "ui"
      ],
      "description": "Architectural layer (enforces dependency rules)"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of this module",
      "examples": [
        "1.0.0",
        "2.1.3"
      ]
    },
    "state": {
      "type": "object",
      "description": "Module state management configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether this module maintains local state",
          "default": false
        },
        "state_file": {
          "type": "string",
          "description": "Path to state file relative to module root",
          "default": ".state/current.json"
        },
        "snapshots_enabled": {
          "type": "boolean",
          "description": "Enable state snapshots for audit trail",
          "default": false
        }
      }
    },
    "artifacts": {
      "type": "object",
      "description": "Module artifacts organized by type",
      "properties": {
        "code": {
          "type": "array",
          "description": "Source code files",
          "items": {
            "type": "object",
            "required": [
              "path",
              "ulid"
            ],
            "properties": {
              "path": {
                "type": "string",
                "description": "Path relative to module root"
              },
              "ulid": {
                "type": "string",
                "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$",
                "description": "Full ULID for this artifact"
              },
              "entry_point": {
                "type": "boolean",
                "description": "Whether this is a primary entry point",
                "default": false
              },
              "exports": {
                "type": "array",
                "description": "Public exports from this file",
                "items": {
                  "type": "object",
                  "required": [
                    "name",
                    "type"
                  ],
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "type": {
                      "type": "string",
                      "enum": [
                        "class",
                        "function",
                        "constant",
                        "type"
                      ]
                    },
                    "signature": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "schemas": {
          "type": "array",
          "description": "JSON/YAML schemas for contracts",
          "items": {
            "type": "object",
            "required": [
              "path",
              "ulid"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "ulid": {
                "type": "string",
                "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
              },
              "validates": {
                "type": "string",
                "description": "What this schema validates (e.g., 'input', 'output', 'config')"
              }
            }
          }
        },
        "tests": {
          "type": "array",
          "description": "Test oracles for this module",
          "items": {
            "type": "object",
            "required": [
              "path",
              "ulid"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "ulid": {
                "type": "string",
                "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
              },
              "test_type": {
                "type": "string",
                "enum": [
                  "unit",
                  "integration",
                  "e2e",
                  "property"
                ],
                "description": "Type of test"
              },
              "coverage_target": {
                "type": "string",
                "description": "Which code artifact this tests (by path or ULID)"
              }
            }
          }
        },
        "docs": {
          "type": "array",
          "description": "Documentation artifacts",
          "items": {
            "type": "object",
            "required": [
              "path",
              "ulid"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "ulid": {
                "type": "string",
                "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
              },
              "doc_type": {
                "type": "string",
                "enum": [
                  "README",
                  "API",
                  "guide",
                  "changelog",
                  "ADR"
                ],
                "description": "Type of documentation"
              }
            }
          }
        },
        "configs": {
          "type": "array",
          "description": "Configuration files",
          "items": {
            "type": "object",
            "required": [
              "path",
              "ulid"
            ],
            "properties": {
              "path": {
                "type": "string"
              },
              "ulid": {
                "type": "string",
                "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
              },
              "config_type": {
                "type": "string",
                "description": "What this configures"
              },
              "schema": {
                "type": "string",
                "description": "ULID of schema that validates this config"
              }
            }
          }
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "Module dependencies",
      "properties": {
        "modules": {
          "type": "array",
          "description": "Other modules this depends on (by module_id)",
          "items": {
            "type": "string"
          },
          "examples": [
            [
              "core-state",
              "schema"
            ]
          ]
        },
        "external": {
          "type": "array",
          "description": "External dependencies (packages)",
          "items": {
            "type": "object",
            "required": [
              "name"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "version": {
                "type": "string"
              },
              "package_manager": {
                "type": "string",
                "enum": [
                  "pip",
                  "npm",
                  "cargo",
                  "go"
                ]
              }
            }
          }
        }
      }
    },
    "import_patterns": {
      "type": "array",
      "description": "Canonical import patterns for AI code generation",
      "items": {
        "type": "object",
        "required": [
          "pattern",
          "description"
        ],
        "properties": {
          "pattern": {
            "type": "string",
            "description": "Import statement pattern",
            "examples": [
              "from core.state.db import init_db"
            ]
          },
          "description": {
            "type": "string"
          },
          "deprecated": {
            "type": "boolean",
            "description": "Mark deprecated import patterns",
            "default": false
          },
          "replacement": {
            "type": "string",
            "description": "Replacement pattern if deprecated"
          }
        }
      }
    },
    "contracts": {
      "type": "object",
      "description": "Module contracts and invariants",
      "properties": {
        "inputs": {
          "type": "array",
          "description": "Input contracts (what this module accepts)",
          "items": {
            "type": "object",
            "required": [
              "name",
              "schema"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "schema": {
                "type": "string",
                "description": "ULID of schema defining this input"
              },
              "description": {
                "type": "string"
              }
            }
          }
        },
        "outputs": {
          "type": "array",
          "description": "Output contracts (what this module produces)",
          "items": {
            "type": "object",
            "required": [
              "name",
              "schema"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "schema": {
                "type": "string",
                "description": "ULID of schema defining this output"
              },
              "description": {
                "type": "string"
              }
            }
          }
        },
        "invariants": {
          "type": "array",
          "description": "Module invariants (properties that must always hold)",
          "items": {
            "type": "object",
            "required": [
              "statement"
            ],
            "properties": {
              "statement": {
                "type": "string",
                "description": "Human and machine-readable invariant",
                "examples": [
                  "All state mutations logged to events table",
                  "Database connections always use connection pool"
                ]
              },
              "enforced_by": {
                "type": "string",
                "description": "Which test enforces this invariant (ULID or path)"
              }
            }
          }
        }
      }
    },
    "ai_metadata": {
      "type": "object",
      "description": "Metadata for AI tools and context loading",
      "properties": {
        "priority": {
          "type": "string",
          "enum": [
            "HIGH",
            "MEDIUM",
            "LOW",
            "EXCLUDE"
          ],
          "description": "AI loading priority",
          "default": "MEDIUM"
        },
        "edit_policy": {
          "type": "string",
          "enum": [
            "safe",
            "review-required",
            "read-only"
          ],
          "description": "Edit safety policy for AI tools",
          "default": "safe"
        },
        "context_tokens_estimate": {
          "type": "integer",
          "description": "Estimated token count for loading this module",
          "minimum": 0
        },
        "key_patterns": {
          "type": "array",
          "description": "Key architectural patterns in this module",
          "items": {
            "type": "string"
          },
          "examples": [
            [
              "State managed via core.state layer",
              "DAG-based dependency resolution"
            ]
          ]
        },
        "common_tasks": {
          "type": "array",
          "description": "Common tasks/operations for this module",
          "items": {
            "type": "object",
            "required": [
              "task",
              "entry_point"
            ],
            "properties": {
              "task": {
                "type": "string"
              },
              "entry_point": {
                "type": "string"
              },
              "example": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "submodules": {
      "type": "array",
      "description": "Submodules (for hierarchical organization)",
      "items": {
        "type": "object",
        "required": [
          "module_id",
          "path"
        ],
        "properties": {
          "module_id": {
            "type": "string"
          },
          "path": {
            "type": "string",
            "description": "Path to submodule manifest"
          },
          "purpose": {
            "type": "string"
          }
        }
      }
    },
    "changelog": {
      "type": "array",
      "description": "Module changelog entries",
      "items": {
        "type": "object",
        "required": [
          "version",
          "date",
          "changes"
        ],
        "properties": {
          "version": {
            "type": "string"
          },
          "date": {
            "type": "string",
            "format": "date"
          },
          "changes": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "breaking": {
            "type": "boolean",
            "description": "Whether this is a breaking change",
            "default": false
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "General metadata",
      "properties": {
        "created": {
          "type": "string",
          "format": "date-time"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time"
        },
        "authors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "status": {
          "type": "string",
          "enum": [
            "active",
            "deprecated",
            "experimental",
            "archived"
          ],
          "default": "active"
        },
        "deprecated_reason": {
          "type": "string",
          "description": "Reason for deprecation (if status=deprecated)"
        },
        "replacement_module": {
          "type": "string",
          "description": "Module ID that replaces this (if deprecated)"
        }
      }
    }
  },
  "doc_id": "DOC-SPEC-MODULE-SCHEMA-003"
}
