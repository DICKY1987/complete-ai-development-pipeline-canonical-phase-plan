{
  "spec_id": "SAFE_MERGE_ORCHESTRATOR_SPEC_V1",
  "version": "1.0.0",
  "status": "draft",
  "doc_id": "DOC-CORE-SAFE-MERGE-ORCHESTRATOR-001",
  "description": "Single, enforced entrypoint for safe merges and pushes in a multi-clone, multi-tool environment.",
  "metadata": {
    "owner": "merge-safety-system",
    "last_updated": "2025-12-03",
    "tags": [
      "git",
      "safe-merge",
      "multi-clone",
      "worktrees",
      "ci-cd"
    ]
  },

  "entrypoints": {
    "human_cli": "pwsh ./scripts/safe_merge_orchestrator.ps1",
    "ai_tools": "pwsh ./scripts/safe_merge_orchestrator.ps1",
    "ci_pipeline": "pwsh ./scripts/safe_merge_orchestrator.ps1 --mode ci",
    "forbidden_direct_git": true
  },

  "filesystem_layout": {
    "scripts_dir": "scripts/",
    "required_scripts": {
      "env_scan": "scripts/merge_env_scan.ps1",
      "auto_merge": "scripts/safe_merge_auto.ps1",
      "safe_pull_push": "scripts/safe_pull_and_push.ps1",
      "multi_clone_guard": "scripts/multi_clone_guard.py",
      "nested_repo_detector": "scripts/nested_repo_detector.py",
      "nested_repo_normalizer": "scripts/nested_repo_normalizer.py",
      "file_classifier": "scripts/merge_file_classifier.py",
      "timestamp_resolver": "scripts/merge_timestamp_resolver.py",
      "sync_log_summary": "scripts/sync_log_summary.py",
      "ai_conflict_resolver": "scripts/ai_conflict_resolver.py",
      "event_emitter": "scripts/safe_merge_emit_event.py",
      "orchestrator": "scripts/safe_merge_orchestrator.ps1"
    },
    "logs_dir": "logs/",
    "state_dir": ".state/safe_merge/",
    "events_file": ".state/safe_merge/merge_events.jsonl"
  },

  "locks": {
    "backend": "file_lock",
    "lock_root": ".git/locks/",
    "resources": {
      "pipeline_lock": {
        "id_pattern": "merge_pipeline_{branch}",
        "scope": "full_pipeline",
        "held_during_phases": [0, 1, 2, 3, 4, 5, 6],
        "timeout_seconds": 900,
        "stale_lock_policy": "delete_if_older_than_timeout_x2"
      },
      "push_lock": {
        "id_pattern": "branch_{branch}",
        "scope": "push_only",
        "held_during_phases": [5],
        "timeout_seconds": 600,
        "stale_lock_policy": "delete_if_older_than_timeout_x2"
      }
    }
  },

  "policies": {
    "sync_health": {
      "enabled": true,
      "source": "scripts/sync_log_summary.py",
      "lookback_minutes": 30,
      "max_error_count": 5,
      "max_high_activity_windows": 0,
      "on_violation": {
        "action": "block_merge",
        "reason_code": "sync_health_failed"
      }
    },

    "nested_repos": {
      "detector_script": "scripts/nested_repo_detector.py",
      "normalizer_script": "scripts/nested_repo_normalizer.py",
      "required_clean_state": true,
      "allowed_stray_repos": 0,
      "default_policy_for_strays": "absorb_as_folder",
      "per_repo_overrides": {
        "patterns/": "keep_as_submodule"
      }
    },

    "file_classification": {
      "classifier_script": "scripts/merge_file_classifier.py",
      "policy_file": "config/merge_policy.yaml",
      "required_classes": [
        "generated",
        "binary",
        "human_text",
        "config_sensitive",
        "do_not_merge"
      ],
      "timestamp_safe_classes": [
        "generated",
        "binary"
      ],
      "never_timestamp_classes": [
        "human_text",
        "config_sensitive",
        "do_not_merge"
      ],
      "on_missing_policy": {
        "action": "block_merge",
        "reason_code": "merge_policy_missing"
      }
    },

    "timestamp_heuristics": {
      "resolver_script": "scripts/merge_timestamp_resolver.py",
      "restricted": true,
      "may_run_only_if": {
        "file_classification_present": true,
        "timestamp_safe_classes_whitelisted": true
      },
      "hard_forbid_on": [
        "human_text",
        "config_sensitive",
        "do_not_merge"
      ],
      "on_violation": {
        "action": "fail_phase",
        "reason_code": "unsafe_timestamp_usage"
      }
    },

    "ai_conflict_resolution": {
      "enabled": true,
      "scope": [
        "human_text",
        "config_sensitive"
      ],
      "max_conflict_files": 20,
      "per_file_timeout_seconds": 120,
      "require_manual_review_if": {
        "ai_confidence_below": 0.7,
        "touched_files_above": 30
      }
    }
  },

  "phases": [
    {
      "id": 0,
      "pattern_id": "MERGE-001-ENV-SCAN",
      "name": "environment_scan",
      "description": "Collect repo + worktree state, verify clean working directory and proper remote configuration.",
      "commands": [
        "pwsh ./scripts/merge_env_scan.ps1 --branch {branch} --output .state/safe_merge/env_scan_{branch}.json"
      ],
      "required_checks": {
        "working_tree_clean": true,
        "no_rebase_in_progress": true,
        "no_merge_in_progress": true
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "env_scan_failed"
      }
    },
    {
      "id": 1,
      "pattern_id": "MERGE-002-SYNC-HEALTH",
      "name": "sync_health_gate",
      "description": "Analyse auto-sync log to detect storms and error clusters before merge.",
      "commands": [
        "python ./scripts/sync_log_summary.py --output .state/safe_merge/sync_summary_{branch}.json"
      ],
      "required_checks": {
        "policy": "sync_health"
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "sync_health_block",
        "hint": "Investigate auto-sync daemon before retrying."
      }
    },
    {
      "id": 2,
      "pattern_id": "MERGE-003-NESTED-REPOS",
      "name": "nested_repo_gate",
      "description": "Detect and normalize nested repositories and stray .git directories.",
      "commands": [
        "python ./scripts/nested_repo_detector.py --output .state/safe_merge/nested_repos_{branch}.json",
        "python ./scripts/nested_repo_normalizer.py --input .state/safe_merge/nested_repos_{branch}.json --policy auto --default {nested_repo_default_policy}"
      ],
      "required_checks": {
        "stray_nested_repo_count_max": 0
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "nested_repo_block"
      }
    },
    {
      "id": 3,
      "pattern_id": "MERGE-008-FILE-CLASSIFIER",
      "name": "file_classification",
      "description": "Classify files into merge-policy classes and materialize merge_policy.yaml decisions.",
      "commands": [
        "python ./scripts/merge_file_classifier.py --policy config/merge_policy.yaml --output .state/safe_merge/merge_file_classes_{branch}.json"
      ],
      "required_checks": {
        "timestamp_safe_classes": [
          "generated",
          "binary"
        ],
        "timestamp_forbidden_classes": [
          "human_text",
          "config_sensitive",
          "do_not_merge"
        ]
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "file_classification_failed"
      }
    },
    {
      "id": 4,
      "pattern_id": "MERGE-004-LOCAL-MERGE",
      "name": "local_merge_and_resolution",
      "description": "Perform local merge, apply restricted timestamp heuristics, and schedule AI/manual conflict resolution.",
      "commands": [
        "git fetch origin {branch}",
        "git merge --no-ff origin/{branch} || echo \"merge_conflicts\" > .state/safe_merge/conflicts_{branch}.flag",
        "python ./scripts/merge_timestamp_resolver.py --input .state/safe_merge/merge_file_classes_{branch}.json --branch {branch} --restrict-classes",
        "python ./scripts/ai_conflict_resolver.py --branch {branch} --file-classes .state/safe_merge/merge_file_classes_{branch}.json --max-files 20"
      ],
      "required_checks": {
        "no_unresolved_conflicts": true
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "conflicts_unresolved"
      }
    },
    {
      "id": 5,
      "pattern_id": "MERGE-006-PULL-PUSH-GUARDED",
      "name": "guarded_pull_and_push",
      "description": "Guarded pull --rebase and push under branch-level lock via multi_clone_guard.",
      "commands": [
        "python ./scripts/multi_clone_guard.py --lock-type pipeline --branch {branch} --command \"pwsh ./scripts/safe_pull_and_push.ps1 -Branch {branch}\""
      ],
      "required_checks": {
        "multi_clone_lock_acquired": true,
        "push_succeeded": true
      },
      "on_failure": {
        "action": "abort_pipeline",
        "reason_code": "guarded_push_failed"
      }
    },
    {
      "id": 6,
      "pattern_id": "MERGE-012-METRICS-AND-LOGS",
      "name": "metrics_and_event_append",
      "description": "Append final event, record metrics, and release locks.",
      "commands": [
        "python ./scripts/safe_merge_emit_event.py --branch {branch} --status success --events-file .state/safe_merge/merge_events.jsonl"
      ],
      "required_checks": {},
      "on_failure": {
        "action": "log_only",
        "reason_code": "metrics_emit_failed"
      }
    }
  ],

  "phase_order": [
    0,
    1,
    2,
    3,
    4,
    5,
    6
  ],

  "events": {
    "event_file": ".state/safe_merge/merge_events.jsonl",
    "schema": {
      "timestamp": "RFC3339 UTC string",
      "branch": "string",
      "phase_id": "integer",
      "phase_name": "string",
      "status": "success|failed|blocked",
      "reason_code": "string",
      "details": "object",
      "invoker": "human|ai|ci",
      "host": "string"
    }
  },

  "ci_integration": {
    "github_actions_example": {
      "workflow_file": ".github/workflows/safe_merge.yml",
      "required_step": "pwsh ./scripts/safe_merge_orchestrator.ps1 --branch ${{ github.ref_name }} --mode ci",
      "block_on_nonzero_exit": true
    }
  }
}
