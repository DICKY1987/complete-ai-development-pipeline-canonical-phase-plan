TITLE: PH-05.5 – Workstream Bundle Generator (Codex Autonomous Phase Executor)

ROLE
You are Codex running with full access to a Windows development environment using PowerShell and Git.
Your job is to COMPLETELY IMPLEMENT phase PH-05.5 (Workstream Bundle Generator) for the AI Development Pipeline project, end-to-end, without requiring further user input.

You will:
- Make it EASY and SAFE to author workstream bundles (`workstreams/*.json`).
- Provide a validated template and an authoring guide for humans/AI.
- Implement a validator script dedicated to workstreams (reusing bundles.py logic).
- Optionally, scaffold an automated planner module (`planner.py`) and rules file for future v2.0 automation.

PRIMARY FOCUS for this phase is **v1.0 (authoring + validation)**.
v2.0 (automated planner) can be implemented as a partial stub with clear TODOs.

OPERATING CONTEXT
- OS: Windows 10/11
- Shell: PowerShell 7+ (pwsh)
- Version control: git
- Orchestrator language: Python 3.12+
- Previous phases (assumed available):
  - PH-00: baseline project skeleton.
  - PH-01: spec index & module stubs.
  - PH-02: SQLite state layer (db.py, schema, state_machine.md).
  - PH-03: tool adapter (tools.py, tool_profiles.json).
  - PH-03.5: Aider integration & prompt engine (prompts.py, Aider helpers).
  - PH-04: workstream bundle parsing & validation (schema/workstream.schema.json, bundles.py, workstreams/).
  - PH-04.5: git worktree lifecycle (worktree.py).
  - PH-05: single-workstream orchestrator core loop (orchestrator.py, run_workstream script).

PROJECT ROOT (IMPORTANT)
- Expected project root: C:\Users\richg\ALL_AI\AI_Dev_Pipeline

If that folder does NOT exist:
- Stop and write a clear, prominent note into docs/PHASE_PLAN.md under PH-05.5 that PH-00–PH-05 must be completed first.
- Do NOT implement the generator in any other path.

If it DOES exist:
- cd into that folder and proceed.

====================================
HIGH-LEVEL GOAL OF PH-05.5
====================================

Create a **workstream authoring system** that:

1) Gives humans/AI a clear, documented way to write `workstreams/*.json` by hand (semi-manual).
2) Provides a canonical **JSON template** for new workstreams.
3) Provides a **validator script** that:
   - Wraps the PH-04 validation pipeline.
   - Gives nice, author-friendly error messages.
4) (Optionally) Introduces an **automated planner stub** (`planner.py`) and decomposition rules file for future v2.0 automation:
   - Reads OpenSpec/CCPM-like inputs.
   - Produces draft workstreams for human review.

You are NOT responsible for full-blown autonomous planning logic yet; your main job is to make manual/deterministic authoring EASY and SAFE.

====================================
REQUIRED OUTPUTS OF THIS PHASE (v1.0)
====================================

By the end of PH-05.5 v1.0, the repo MUST have at minimum:

1) AUTHORING GUIDE
- docs/workstream_authoring_guide.md

This must clearly explain:

1) Purpose of workstream bundles
   - How they relate to:
     - OpenSpec changes (`openspec_change`, `gate`).
     - CCPM / issues (`ccpm_issue`).
     - Files, tasks, and tests for each workstream.

2) Where bundles live
   - Default directory:
     - <PROJECT_ROOT>/workstreams/
   - Override via env var:
     - PIPELINE_WORKSTREAM_DIR
   - Reference to PH-04 (schema/workstream.schema.json) and bundles.py.

3) Required fields (aligned with JSON Schema)
   - id (pattern: "ws-...")
   - openspec_change
   - ccpm_issue
   - gate
   - files_scope
   - files_create (optional)
   - tasks
   - acceptance_tests (optional)
   - depends_on (optional)
   - tool
   - circuit_breaker (optional)
   - metadata (optional)

4) Authoring rules
   - Use a SINGLE OpenSpec change per workstream (`openspec_change`).
   - Keep workstreams reasonably sized (e.g., 3–7 tasks).
   - Avoid overlapping `files_scope` unless absolutely necessary.
   - Use `depends_on` when one workstream logically requires another to finish first.
   - Give meaningful `tasks` and `acceptance_tests` descriptions so AIs & humans know what “done” looks like.

5) Step-by-step authoring workflow
   - Steps like:
     1) Identify OpenSpec change(s) you’re implementing.
     2) Break into workstreams:
        - e.g., “backend changes”, “PowerShell scripts”, “tests & docs”.
     3) For each workstream:
        - Define `id`, `files_scope`, `tasks`, `acceptance_tests`, `tool`.
        - Fill in the template (see below).
     4) Run the validator (`scripts/validate_workstreams_authoring.py`).
     5) Fix any validation errors.
     6) Commit bundles to git.

6) Example(s)
   - At least one small example based on an existing example bundle (or copy/refine `example_multi.json`) with notes showing why it was decomposed that way.

2) CANONICAL JSON TEMPLATE
- templates/workstream_template.json

This is a **single-workstream JSON file** that authors can copy and fill in.

- Required content:
  - All fields from the schema, with placeholder values and comments (where legal in JSON).
  - Since JSON does not allow comments, you can:
    - Provide a “comment” field that authors can delete, OR
    - Use a separate Markdown snippet in docs/workstream_authoring_guide.md to explain each field.
  - Template should be as close as possible to real bundles:
    {
      "id": "ws-descriptive-slug-here",
      "openspec_change": "OS-1234",
      "ccpm_issue": 42,
      "gate": 1,
      "files_scope": [
        "src/module/foo.py",
        "scripts/something.ps1"
      ],
      "files_create": [
        "src/module/new_component.py"
      ],
      "tasks": [
        "Implement X feature in foo.py",
        "Add Y PowerShell script to automate Z"
      ],
      "acceptance_tests": [
        "pytest -q",
        "pwsh -File scripts/run_smoke_tests.ps1"
      ],
      "depends_on": [
        "ws-other-workstream-id"
      ],
      "tool": "aider",
      "circuit_breaker": {
        "max_attempts": 5,
        "max_error_repeats": 3,
        "oscillation_threshold": 2
      },
      "metadata": {
        "owner": "team-name-or-github-handle",
        "notes": "Additional free-form notes here"
      }
    }

- The authoring guide should refer explicitly to this template and explain how to use it.

3) AUTHORING-FOCUSED VALIDATION SCRIPT
- scripts/validate_workstreams_authoring.py

This is a convenience script specifically for **authors** and **AI agents** who are editing bundles.

Requirements:

- Runnable as:
  - python scripts/validate_workstreams_authoring.py
  - python scripts/validate_workstreams_authoring.py --dir path/to/workstreams
  - python scripts/validate_workstreams_authoring.py --json

Behavior:

1) Determine workstream directory:
   - If --dir provided, use that.
   - Else:
     - Use PIPELINE_WORKSTREAM_DIR if set.
     - Else default to <PROJECT_ROOT>/workstreams.

2) Call into bundles.py:
   - load_and_validate_bundles() for that directory.
   - detect_filescope_overlaps().

3) On success:
   - Print:
     - "N workstream bundles validated successfully."
     - List of workstream IDs (optional).
   - Exit code 0.

4) On failures:
   - Distinguish between:
     - Schema validation errors (missing fields, wrong types).
     - Dependency errors (missing or cyclic depends_on).
     - Filescope overlap errors.
   - Print human-readable messages with:
     - Filename
     - Workstream id
     - Error type and details
   - Exit with non-zero code.

5) --json option:
   - Instead of human-readable messages, output a JSON summary:
     {
       "ok": false,
       "bundles_checked": 5,
       "errors": [
         {
           "type": "schema",
           "file": "workstreams/ws-foo.json",
           "id": "ws-foo",
           "details": "Missing required property 'files_scope'"
         },
         {
           "type": "overlap",
           "file": null,
           "id": null,
           "details": "File 'src/foo.py' claimed by ws-foo and ws-bar"
         }
       ]
     }
   - Useful for AI tools and automated checks.

4) OPTIONAL: CI HOOK EXAMPLE
- Optionally add a short section to README.md or docs/ARCHITECTURE.md showing:
  - How to hook this validator into CI (e.g., `python scripts/validate_workstreams_authoring.py --json`) as a gate before orchestrator runs.

====================================
OPTIONAL V2.0+ OUTPUTS (PLANNER STUB)
====================================

You may create **stubs** for future automation, but keep them clearly marked as experimental/optional.

1) planner.py – DRAFT AUTOMATED PLANNER
- src/pipeline/planner.py

Responsibilities (for now, mostly TODOs):

- Provide a high-level API like:
  - plan_workstreams_from_spec(spec_source, options) -> list[dict]
    - spec_source: placeholder for OpenSpec/CCPM data (could be a path, ID, or structured dict).
    - options: planning options (max workstreams, grouping strategy, etc.).

- For this phase:
  - Implement function skeletons with docstrings and `NotImplementedError` or minimal placeholder logic.
  - Document in comments where:
    - Decomposition rules will be applied.
    - Filescope inference will occur (e.g., from changed files lists).
    - Aider or other AI tools might help propose workstreams.

2) decomposition_rules.yaml
- config/decomposition_rules.yaml

Provide a simple YAML file describing some example rules like:

- Group by language:
  - Python changes vs PowerShell changes.
- Group by directory:
  - `src/pipeline/*` vs `scripts/*` vs `docs/*`.
- Limit workstream size:
  - max_files_per_workstream: 10
  - max_tasks_per_workstream: 7

These should be placeholders for future logic, documented as **not yet enforced**.

3) generate-workstreams CLI (optional)
- scripts/generate_workstreams.py

For now:
- Provide a stub CLI that:
  - Parses arguments (e.g., --spec-id, --output-dir).
  - Prints a message like:
    - "Planner v0 stub: not yet implemented. See src/pipeline/planner.py."
- Or, if you want to go a bit further, have it:
  - Read decomposition_rules.yaml.
  - Emit a trivial one-workstream bundle from a minimal input (like a spec id string).
- Clearly document in code and docs that this is experimental.

====================================
UNIT TESTS
====================================

Add tests focused on the **authoring workflow**:

- tests/pipeline/test_workstream_authoring.py

Test cases:

1) Template validity:
   - Load templates/workstream_template.json.
   - Validate it with schema/workstream.schema.json via bundles.validate_bundle_data().
   - Assert it passes (after substituting placeholder values if needed).

2) Validator success:
   - Create a temp directory with:
     - 2–3 simple valid bundles based on the template.
   - Point validate_workstreams_authoring.py at this dir (via --dir).
   - Run as a subprocess:
     - Assert exit code 0.
     - Assert output mentions “validated successfully”.

3) Validator schema failure:
   - Create an invalid bundle (e.g., missing id).
   - Assert:
     - Exit code non-zero.
     - Output mentions missing property and filename.

4) Validator overlap failure:
   - Create two bundles with overlapping `files_scope`.
   - Assert:
     - Exit code non-zero.
     - Output mentions overlap and file name.

5) Validator JSON mode:
   - Run with --json on a failing set.
   - Parse JSON output.
   - Assert that errors array is non-empty and contains structured info.

(If planner stubs exist, you can add a minimal test to ensure planner API imports and raises NotImplementedError with a clear message.)

====================================
DOCUMENTATION UPDATES
====================================

Update:

1) docs/ARCHITECTURE.md
   - Add/update a subsection “Workstream Authoring & Generation” explaining:
     - The role of:
       - docs/workstream_authoring_guide.md
       - templates/workstream_template.json
       - scripts/validate_workstreams_authoring.py
     - How this ties into:
       - PH-04 validation (bundles.py, workstream.schema.json).
       - PH-05 orchestrator (which assumes valid bundles).

2) docs/PHASE_PLAN.md
   - Flesh out PH-05.5 section with:
     - Summary of the authoring system.
     - Distinction between:
       - v1.0 manual authoring.
       - v2.0 future automated planner.
     - List of artifacts:
       - docs/workstream_authoring_guide.md
       - templates/workstream_template.json
       - scripts/validate_workstreams_authoring.py
       - (optional) src/pipeline/planner.py, config/decomposition_rules.yaml, scripts/generate_workstreams.py
       - tests/pipeline/test_workstream_authoring.py

3) README.md (optional)
   - Add a short “Authoring Workstreams” section linking to the authoring guide and validator script.

====================================
GIT COMMIT
====================================

- Stage all new/modified files.
- Commit with message:
  - "PH-05.5: workstream bundle generator (authoring + validation)"
- Do NOT push (remote configuration is out of scope).

====================================
CONSTRAINTS & PRINCIPLES
====================================

- Do NOT break or remove outputs from PH-00–PH-05; extend them only.
- Do NOT silently loosen the JSON Schema from PH-04; the authoring template must comply with it.
- Make the authoring path **friendly**:
  - Clear error messages.
  - Simple template.
  - Obvious, documented steps in the guide.
- For planner-related artifacts:
  - Be explicit about “experimental / TODO” so future agents know what is production-critical vs aspirational.

====================================
EXECUTION PLAN (WHAT YOU SHOULD DO)
====================================

You should:

1) PRECHECKS & NAVIGATION
   - Confirm C:\Users\richg\ALL_AI\AI_Dev_Pipeline exists.
   - cd C:\Users\richg\ALL_AI\AI_Dev_Pipeline
   - Confirm src/pipeline/, docs/, schema/, templates/, scripts/ exist; create missing folders as needed.

2) AUTHORING GUIDE
   - Write docs/workstream_authoring_guide.md with:
     - Purpose, fields, rules, and examples as specified.

3) TEMPLATE
   - Create templates/workstream_template.json that fully matches schema/workstream.schema.json.
   - Reference it from the authoring guide.

4) VALIDATOR SCRIPT
   - Implement scripts/validate_workstreams_authoring.py using bundles.py.
   - Support:
     - --dir
     - --json
   - Implement clear error reporting and proper exit codes.

5) TESTS
   - Implement tests/pipeline/test_workstream_authoring.py.
   - Cover template validity, validation success/failure, overlap detection, and JSON_mode.

6) OPTIONAL PLANNER STUB
   - Implement src/pipeline/planner.py with function skeletons and docstrings.
   - Create config/decomposition_rules.yaml with sample rules.
   - Implement scripts/generate_workstreams.py as a stub CLI that clearly indicates its current limitations.

7) RUN TESTS
   - From project root:
     - Run: pytest
   - Fix any failing tests before marking PH-05.5 complete.

8) UPDATE DOCS
   - Update docs/ARCHITECTURE.md and docs/PHASE_PLAN.md as described.

9) GIT COMMIT
   - Stage and commit with:
     - "PH-05.5: workstream bundle generator (authoring + validation)"

====================================
PHASE COMPLETION CHECKLIST
====================================

Before you consider PH-05.5 done, ensure all of the following are true:

[ ] docs/workstream_authoring_guide.md exists and explains:
    - fields
    - authoring rules
    - workflow for creating/validating bundles
[ ] templates/workstream_template.json exists and passes schema validation (after filling placeholders)
[ ] scripts/validate_workstreams_authoring.py exists, supports --dir and --json, and:
    - exits 0 on success
    - non-zero on errors with clear messages
[ ] tests/pipeline/test_workstream_authoring.py exists and passes
[ ] (Optional) src/pipeline/planner.py, config/decomposition_rules.yaml, and scripts/generate_workstreams.py exist as clearly-marked stubs for v2.0
[ ] docs/ARCHITECTURE.md has a “Workstream Authoring & Generation” section
[ ] docs/PHASE_PLAN.md has an updated PH-05.5 section listing artifacts and behavior
[ ] A git commit with message like "PH-05.5: workstream bundle generator (authoring + validation)" has been created

====================================
INTERACTION STYLE
====================================

- Do NOT ask the user questions unless you are completely blocked.
- Make reasonable assumptions and document them in:
  - docs/workstream_authoring_guide.md
  - docs/PHASE_PLAN.md (PH-05.5 section)
- When you output your response, clearly separate:
  - PowerShell commands you would run.
  - JSON, Python, Markdown, and YAML file contents you would create or modify.

END OF PROMPT
