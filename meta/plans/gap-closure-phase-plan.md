# Gap-closure phase plan

This plan closes gaps identified against the canonical checklist across phases
00–09. It defines concrete tasks, acceptance criteria, and quick verification
commands. Tasks are grouped by phase; cross-cutting items appear first.

## Goals
- Restore green test runs with minimal changes to existing code.
- Fill missing helpers/CLIs/tests referenced by the checklist.
- Align documentation sections and references.

## Non-goals
- Implement the GUI layer (PH‑07) in this pass; defer to a follow-up plan.
- Broad refactors unrelated to the checklist.

## Cross-cutting tasks
- [ ] Dependencies: add `PyYAML` to `requirements.txt` to satisfy `aim_bridge`.
  - DoD: `pytest -q` collects tests without `ModuleNotFoundError: yaml`.
  - Verify: `pwsh scripts/test.ps1` returns exit code 0 (or only test failures unrelated to deps).
- [ ] Optional linters: configure `markdownlint` (npm) if desired.
  - DoD: `markdownlint` runs with zero errors or documented ignores.
  - Verify: `pwsh scripts/test.ps1` shows markdownlint step.

## Phase 00 — Baseline & project skeleton
- [ ] Ensure `scripts/test.ps1` passes in a clean environment.
  - DoD: No import errors; clean run on a fresh clone after installing `requirements.txt`.
  - Verify: `pwsh scripts/test.ps1` exits with 0.

## Phase 01 — Spec alignment & index mapping
- [ ] Add explicit section in `docs/ARCHITECTURE.md` for “Spec mapping & IDX index”.
  - DoD: Section exists and references `docs/spec/spec_index_map.md` and generator script.
  - Verify: open `docs/ARCHITECTURE.md` and locate the section header.

## Phase 02 — Data model & state machine
- [ ] Implement `validate_state_transition()` in the DB/state layer.
  - DoD: Helper prevents invalid transitions for runs and workstreams.
  - Verify: unit tests below pass.
- [ ] Add tests `tests/pipeline/test_db_state.py` for schema and transitions.
  - DoD: Covers valid/invalid transitions and persistence of events/errors.
  - Verify: `pytest -q tests/pipeline/test_db_state.py` passes.

## Phase 03 — Tool profiles & adapter layer
- [ ] Wire tool adapter to optional DB event logging (guarded to avoid failures).
  - DoD: On successful run, emits `tool_run` events when DB available.
  - Verify: run a tool via adapter and inspect events table.
- [ ] Add tests `tests/pipeline/test_tools.py` for profile rendering/exec.
  - DoD: Mocks subprocess, asserts command render, timeout, and result mapping.
  - Verify: `pytest -q tests/pipeline/test_tools.py` passes.

## Phase 03.5 — Aider integration & prompts
- [ ] No blocking gap; keep as-is.

## Phase 04 — Workstream bundle parsing & validation
- [ ] No blocking gap; keep as-is.

## Phase 04.5 — Git worktree lifecycle
- [ ] Add CLI `scripts/worktrees.py` for create/inspect/clean operations.
  - DoD: CLI supports `create`, `inspect`, `clean` with help text.
  - Verify: `python scripts/worktrees.py --help` shows commands.
- [ ] Add tests `tests/pipeline/test_worktree.py` covering lifecycle paths.
  - DoD: Uses temp dirs; asserts paths and scope validation behavior.
  - Verify: `pytest -q tests/pipeline/test_worktree.py` passes.

## Phase 05 — Orchestrator core loop (single workstream)
- [ ] No blocking gap; keep as-is.

## Phase 05.5 — Workstream authoring & generation
- [ ] No blocking gap; keep as-is.

## Phase 06 — Circuit breakers, retries & fix loop
- [ ] Add unit tests `tests/pipeline/test_circuit_breakers.py` for breaker config and signatures.
  - DoD: Covers thresholds, backoff, and signature hashing behavior.
  - Verify: `pytest -q tests/pipeline/test_circuit_breakers.py` passes.
- [ ] Validate static fix loop path and add runtime oscillation test if applicable.
  - DoD: Test demonstrates diff-hash oscillation detection preventing infinite loops.
  - Verify: `pytest -q tests/pipeline/test_fix_loop.py` continues to pass; add runtime test if needed.

## Phase 07 — GUI layer & plugin system (deferred)
- [ ] Create follow-up plan `plans/phase-07-gui.md` with scope, MVP shell, and risks.
  - DoD: Documented plan ready for scheduling; no code in this pass.

## Phase 08 — AIM tool registry integration
- [ ] Add `PyYAML` dependency and ensure `aim_bridge` import works.
  - DoD: `import yaml` succeeds during test collection.
  - Verify: `pytest -q tests/pipeline/test_aim_bridge.py::test_*` collects.
- [ ] Make tests resilient without a local `.AIM_ai-tools-registry` by mocking FS lookups.
  - DoD: Tests run in CI without external registry.
  - Verify: all `tests/pipeline/test_aim_bridge.py` pass.

## Phase 09 — Multi-document versioning & spec management
- [ ] Add tests under `tests/tools/` for the spec tools suite.
  - DoD: Unit tests for `spec_indexer`, `spec_resolver`, `spec_patcher`, `spec_renderer`, `spec_guard`.
  - Verify: `pytest -q tests/tools` passes; `docs/index.json` generated by test harness in tmp dir.

## Milestones
- M1: Dependencies fixed; tests collect (PH‑00/08).
- M2: DB/state machine tests passing (PH‑02).
- M3: Adapter + worktree CLI/tests (PH‑03/04.5).
- M4: Circuit-breaker tests green (PH‑06).
- M5: AIM tests green with mocks (PH‑08).
- M6: Spec tools covered by tests (PH‑09).

## Runbook
- Install deps: `python -m pip install -r requirements.txt`
- Run tests: `pwsh scripts/test.ps1`
- Lint markdown (optional): `npm i -g markdownlint-cli` then `markdownlint **/*.md`

## Risks & mitigations
- External registry absence breaks AIM tests → mitigate by mocking FS and environment.
- Platform differences (Windows paths) in worktree tests → normalize paths in asserts.
- Optional tools (markdownlint) not installed in CI → mark as optional in scripts.

