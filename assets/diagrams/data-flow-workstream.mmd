%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px'}}}%%
graph TD
    %% User Input
    USER["ğŸ‘¤ User"]
    WS_JSON["ğŸ“¦ workstreams/*.json<br/><small>Workstream Bundle</small>"]
    
    %% Validation & Loading
    VALIDATE["âœ… Validate Bundle<br/><small>core.state.bundles</small>"]
    LOAD_DB["ğŸ’¾ Load to Database<br/><small>core.state.crud</small>"]
    BUILD_DAG["ğŸ”— Build Dependency DAG<br/><small>core.state.bundles</small>"]
    
    %% Scheduling
    SCHEDULER["ğŸ“… Schedule Workstreams<br/><small>core.engine.scheduler</small>"]
    RESOLVE_DEPS["ğŸ”€ Resolve Dependencies<br/><small>core.engine.scheduler</small>"]
    
    %% Execution Loop
    ORCHESTRATOR["âš™ï¸ Execute Workstream<br/><small>core.engine.orchestrator</small>"]
    CREATE_WORKTREE["ğŸŒ³ Create Git Worktree<br/><small>core.state.worktree</small>"]
    
    %% Step Phases
    EDIT_PHASE["âœï¸ EDIT Phase<br/><small>Code Generation</small>"]
    STATIC_PHASE["ğŸ” STATIC Phase<br/><small>Linting/Validation</small>"]
    RUNTIME_PHASE["â–¶ï¸ RUNTIME Phase<br/><small>Testing/Execution</small>"]
    
    %% Step Execution
    EXECUTOR["â–¶ï¸ Execute Step<br/><small>core.engine.executor</small>"]
    LOAD_PROFILE["âš™ï¸ Load Tool Profile<br/><small>core.engine.tools</small>"]
    INVOKE_TOOL["ğŸ”¨ Invoke External Tool<br/><small>Aider, pytest, etc.</small>"]
    
    %% Error Handling
    CHECK_CB["ğŸ”Œ Check Circuit Breaker<br/><small>core.engine.circuit_breakers</small>"]
    HANDLE_ERROR["âŒ Handle Failure<br/><small>core.engine.recovery</small>"]
    RETRY["ğŸ”„ Retry Step"]
    
    %% Completion
    UPDATE_STATE["ğŸ’¾ Update State<br/><small>core.state.crud</small>"]
    CLEANUP["ğŸ§¹ Cleanup Worktree<br/><small>core.state.worktree</small>"]
    ARCHIVE["ğŸ“ Archive Results<br/><small>core.planning.archive</small>"]
    
    %% Results
    RESULTS["âœ… Workstream Complete"]
    
    %% Flow
    USER --> WS_JSON
    WS_JSON --> VALIDATE
    VALIDATE --> LOAD_DB
    LOAD_DB --> BUILD_DAG
    BUILD_DAG --> SCHEDULER
    
    SCHEDULER --> RESOLVE_DEPS
    RESOLVE_DEPS --> ORCHESTRATOR
    
    ORCHESTRATOR --> CREATE_WORKTREE
    CREATE_WORKTREE --> EDIT_PHASE
    
    EDIT_PHASE --> STATIC_PHASE
    STATIC_PHASE --> RUNTIME_PHASE
    
    EDIT_PHASE --> EXECUTOR
    STATIC_PHASE --> EXECUTOR
    RUNTIME_PHASE --> EXECUTOR
    
    EXECUTOR --> LOAD_PROFILE
    LOAD_PROFILE --> CHECK_CB
    CHECK_CB -->|"Not Tripped"| INVOKE_TOOL
    CHECK_CB -->|"Tripped"| HANDLE_ERROR
    
    INVOKE_TOOL -->|"Success"| UPDATE_STATE
    INVOKE_TOOL -->|"Failure"| HANDLE_ERROR
    
    HANDLE_ERROR --> RETRY
    RETRY --> EXECUTOR
    HANDLE_ERROR -->|"Max Retries"| UPDATE_STATE
    
    UPDATE_STATE -->|"More Steps"| EXECUTOR
    UPDATE_STATE -->|"Complete"| CLEANUP
    
    CLEANUP --> ARCHIVE
    ARCHIVE --> RESULTS
    
    %% Styling
    classDef userStyle fill:#9B59B6,stroke:#6C3483,stroke-width:2px,color:#fff
    classDef validationStyle fill:#3498DB,stroke:#2874A6,stroke-width:2px,color:#fff
    classDef executionStyle fill:#4A90E2,stroke:#2E5C8A,stroke-width:2px,color:#fff
    classDef phaseStyle fill:#F39C12,stroke:#D68910,stroke-width:2px,color:#fff
    classDef errorStyle fill:#E74C3C,stroke:#C0392B,stroke-width:2px,color:#fff
    classDef successStyle fill:#27AE60,stroke:#1E8449,stroke-width:2px,color:#fff
    
    class USER,WS_JSON userStyle
    class VALIDATE,LOAD_DB,BUILD_DAG validationStyle
    class SCHEDULER,RESOLVE_DEPS,ORCHESTRATOR,EXECUTOR,LOAD_PROFILE,INVOKE_TOOL,CREATE_WORKTREE executionStyle
    class EDIT_PHASE,STATIC_PHASE,RUNTIME_PHASE phaseStyle
    class CHECK_CB,HANDLE_ERROR,RETRY errorStyle
    class UPDATE_STATE,CLEANUP,ARCHIVE,RESULTS successStyle
