%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'14px'}}}%%
graph LR
    %% Entry Points
    USER["ğŸ‘¤ User/CLI"]
    SCRIPTS["ğŸ”§ scripts/"]
    
    %% Core Components
    BUNDLES["ğŸ“¦ core.state.bundles<br/><small>Bundle Loading</small>"]
    DB["ğŸ’¾ core.state.db<br/><small>Database</small>"]
    CRUD["ğŸ“ core.state.crud<br/><small>CRUD Ops</small>"]
    WORKTREE["ğŸŒ³ core.state.worktree<br/><small>Git Worktrees</small>"]
    
    ORCHESTRATOR["âš™ï¸ core.engine.orchestrator<br/><small>Workstream Execution</small>"]
    SCHEDULER["ğŸ“… core.engine.scheduler<br/><small>Multi-Workstream</small>"]
    EXECUTOR["â–¶ï¸ core.engine.executor<br/><small>Step Execution</small>"]
    TOOLS["ğŸ”¨ core.engine.tools<br/><small>Tool Profiles</small>"]
    CB["ğŸ”Œ core.engine.circuit_breakers<br/><small>Failure Protection</small>"]
    RECOVERY["ğŸ”„ core.engine.recovery<br/><small>Error Recovery</small>"]
    
    PLANNER["ğŸ§  core.planning.planner<br/><small>Workstream Gen</small>"]
    ARCHIVE["ğŸ“ core.planning.archive<br/><small>Archive Utils</small>"]
    
    OPENSPEC["ğŸ“„ core.openspec_parser<br/><small>Spec Parsing</small>"]
    
    %% Error Detection
    ERROR_ENGINE["ğŸ” error.engine.error_engine<br/><small>Error Detection</small>"]
    ERROR_STATE["âš¡ error.engine.error_state_machine<br/><small>State Transitions</small>"]
    PLUGIN_MGR["ğŸ”Œ error.plugin_manager<br/><small>Plugin Loading</small>"]
    PLUGINS["ğŸ› ï¸ error.plugins.*<br/><small>Linters & Validators</small>"]
    
    %% External Integrations
    AIM_BRIDGE["ğŸ¯ aim.bridge<br/><small>AIM Integration</small>"]
    AIDER["ğŸ¤– aider/*<br/><small>Aider Integration</small>"]
    
    %% Shim Layer (Backward Compatibility)
    SHIM_SRC["âš ï¸ src.pipeline.*<br/><small>Legacy Shims</small>"]
    SHIM_MOD["âš ï¸ MOD_ERROR_PIPELINE.*<br/><small>Legacy Shims</small>"]
    
    %% User Flow
    USER --> SCRIPTS
    SCRIPTS --> ORCHESTRATOR
    SCRIPTS --> SCHEDULER
    SCRIPTS --> ERROR_ENGINE
    
    %% Core State Dependencies
    BUNDLES --> DB
    CRUD --> DB
    WORKTREE --> DB
    
    %% Core Engine Dependencies
    ORCHESTRATOR --> BUNDLES
    ORCHESTRATOR --> CRUD
    ORCHESTRATOR --> EXECUTOR
    ORCHESTRATOR --> WORKTREE
    ORCHESTRATOR --> OPENSPEC
    
    SCHEDULER --> BUNDLES
    SCHEDULER --> ORCHESTRATOR
    SCHEDULER --> CRUD
    
    EXECUTOR --> TOOLS
    EXECUTOR --> CRUD
    EXECUTOR --> CB
    EXECUTOR --> RECOVERY
    
    RECOVERY --> CRUD
    CB --> CRUD
    
    %% Planning Dependencies
    PLANNER --> BUNDLES
    PLANNER --> CRUD
    ARCHIVE --> CRUD
    
    %% Error Detection Dependencies
    ERROR_ENGINE --> PLUGIN_MGR
    ERROR_ENGINE --> ERROR_STATE
    ERROR_ENGINE --> CRUD
    
    PLUGIN_MGR --> PLUGINS
    ERROR_STATE --> CRUD
    
    %% External Integration Dependencies
    ORCHESTRATOR -.-> AIM_BRIDGE
    EXECUTOR -.-> AIDER
    
    %% Shim Layer (Deprecated)
    SHIM_SRC -.-> ORCHESTRATOR
    SHIM_SRC -.-> BUNDLES
    SHIM_SRC -.-> CRUD
    SHIM_SRC -.-> DB
    
    SHIM_MOD -.-> ERROR_ENGINE
    SHIM_MOD -.-> PLUGIN_MGR
    
    %% Styling
    classDef userStyle fill:#9B59B6,stroke:#6C3483,stroke-width:2px,color:#fff
    classDef coreStyle fill:#4A90E2,stroke:#2E5C8A,stroke-width:2px,color:#fff
    classDef errorStyle fill:#E24A4A,stroke:#8A2E2E,stroke-width:2px,color:#fff
    classDef integrationStyle fill:#50C878,stroke:#2E8A4E,stroke-width:2px,color:#fff
    classDef shimStyle fill:#999,stroke:#666,stroke-width:1px,stroke-dasharray: 5 5,color:#fff
    
    class USER,SCRIPTS userStyle
    class BUNDLES,DB,CRUD,WORKTREE,ORCHESTRATOR,SCHEDULER,EXECUTOR,TOOLS,CB,RECOVERY,PLANNER,ARCHIVE,OPENSPEC coreStyle
    class ERROR_ENGINE,ERROR_STATE,PLUGIN_MGR,PLUGINS errorStyle
    class AIM_BRIDGE,AIDER integrationStyle
    class SHIM_SRC,SHIM_MOD shimStyle
