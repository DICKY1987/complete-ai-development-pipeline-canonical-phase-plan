name: Quality Gates

permissions:
  contents: read
  security-events: write

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  glossary-ssot-policy:
    name: Glossary SSOT Policy Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate SSOT Policy
        run: python scripts/glossary_ssot_policy.py --verbose

  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Black format check
        run: |
          black --check core/ scripts/ tests/ \
            --exclude '(core/autonomous/error_analyzer\.py|core/autonomous/fix_generator\.py|core/autonomous/reflexion\.py|core/memory/pattern_learner\.py|core/memory/episodic_memory\.py|core/search/hyde\.py|core/terminal/context_manager\.py|core/terminal/state_capture\.py|scripts/dev/generate_path_index\.py|scripts/exec017_quick_cleanup\.py|tests/engine/test_plan_execution\.py)'

      - name: isort import check
        run: |
          isort --check --profile black core/ scripts/ tests/ \
            --skip core/autonomous/error_analyzer.py \
            --skip core/autonomous/fix_generator.py \
            --skip core/autonomous/reflexion.py \
            --skip core/memory/pattern_learner.py \
            --skip core/memory/episodic_memory.py \
            --skip core/search/hyde.py \
            --skip core/terminal/context_manager.py \
            --skip core/terminal/state_capture.py \
            --skip scripts/dev/generate_path_index.py \
            --skip scripts/exec017_quick_cleanup.py \
            --skip tests/engine/test_plan_execution.py

      - name: Ruff lint
        run: ruff check core/ scripts/ tests/ || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-cov pytest-xdist

      - name: Run tests
        run: pytest -v --tb=short --cov=core

      - name: Coverage gate (error_engine/plugins, line+branch)
        if: matrix.python-version == '3.12'
        run: |
          pytest -v --tb=short \
            --cov=phase6_error_recovery/modules/error_engine/src \
            --cov=phase6_error_recovery/modules/plugins \
            --cov-branch \
            --cov-fail-under=70

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate deprecated paths
        run: |
          if [ -f "scripts/paths_index_cli.py" ]; then
            python scripts/paths_index_cli.py gate --db refactor_paths.db || true
          fi

      - name: Validate workstreams
        run: |
          if [ -f "scripts/validate_workstreams.py" ]; then
            python scripts/validate_workstreams.py || true
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
