name: Quality Gates

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  glossary-ssot-policy:
    name: Glossary SSOT Policy Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate SSOT Policy
        run: python scripts/glossary_ssot_policy.py --verbose

  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install black isort ruff

      - name: Black format check
        run: black --check core/ engine/ error/ aim/ pm/ scripts/ tests/

      - name: isort import check
        run: isort --check --profile black core/ engine/ error/ aim/ pm/ scripts/ tests/

      - name: Ruff lint
        run: ruff check core/ engine/ error/ aim/ pm/ scripts/ tests/ || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pytest pytest-cov pytest-xdist

      - name: Run tests
        run: pytest -v --tb=short --cov=core --cov=engine --cov=error --cov=aim --cov=pm

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate deprecated paths
        run: |
          if [ -f "scripts/paths_index_cli.py" ]; then
            python scripts/paths_index_cli.py gate --db refactor_paths.db || true
          fi

      - name: Validate workstreams
        run: |
          if [ -f "scripts/validate_workstreams.py" ]; then
            python scripts/validate_workstreams.py || true
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
