doc_id: DOC-CONFIG-TOOL-PROFILE-ANNOTATED-043
# Tool Profile Configuration - Annotated Example

# This file demonstrates all configuration options for tool profiles used in workstreams.
# Tool profiles define how the orchestrator interacts with different AI coding tools.

---
# ============================================================================
# SECTION 1: Basic Tool Profiles
# ============================================================================
# Simple tool definitions for common AI coding assistants

tools:
  # Aider - AI pair programming tool (most common)
  aider:
    # Human-readable name for UI display
    name: "Aider AI"
    
    # Tool type determines which adapter to use
    # Options: aider, codex, custom, manual
    type: "aider"
    
    # Command to execute the tool
    # Variables: ${workstream_id}, ${task}, ${files}
    command: "aider"
    
    # Command-line arguments
    args:
      - "--yes"  # Auto-confirm changes (non-interactive mode)
      - "--no-git"  # Don't create git commits (pipeline handles versioning)
      - "--model"
      - "gpt-4"  # AI model to use
    
    # Environment variables to set
    env:
      AIDER_DARK_MODE: "true"
      AIDER_NO_AUTO_COMMITS: "true"
    
    # Working directory (relative to repo root)
    # Use ${worktree_path} for isolated execution
    working_dir: "${worktree_path}"
    
    # Timeout configuration
    timeout:
      # Maximum execution time in seconds
      default: 600  # 10 minutes
      
      # Timeout per task (if multiple tasks in step)
      per_task: 300  # 5 minutes
      
      # Grace period before force-kill
      grace_period: 30  # 30 seconds
    
    # Retry configuration
    retry:
      # Enable automatic retries on failure
      enabled: true
      
      # Maximum retry attempts
      max_attempts: 3
      
      # Backoff strategy: linear, exponential, fixed
      strategy: "exponential"
      
      # Initial delay between retries (seconds)
      initial_delay: 5
      
      # Maximum delay between retries (seconds)
      max_delay: 60
      
      # Retry on these error patterns (regex)
      retry_on:
        - "rate limit"
        - "timeout"
        - "connection error"
      
      # Don't retry on these error patterns
      no_retry_on:
        - "invalid api key"
        - "authentication failed"
        - "syntax error in generated code"
    
    # Circuit breaker configuration
    circuit_breaker:
      # Enable circuit breaker pattern
      enabled: true
      
      # Max failures before opening circuit
      failure_threshold: 3
      
      # Max consecutive same errors before escalation
      max_error_repeats: 2
      
      # Time window for counting failures (seconds)
      window: 300  # 5 minutes
      
      # How long to keep circuit open (seconds)
      cooldown: 60  # 1 minute
      
      # Half-open state: allow 1 request after cooldown
      half_open_max_attempts: 1
    
    # Input/output configuration
    io:
      # How to pass tasks to the tool
      # Options: stdin, file, args
      task_input_method: "args"
      
      # How to capture tool output
      # Options: stdout, file, both
      output_capture: "both"
      
      # File paths for file-based I/O
      task_file: "${worktree_path}/.task.txt"
      output_file: "${worktree_path}/.output.txt"
      error_file: "${worktree_path}/.error.txt"
    
    # Success detection
    success:
      # Exit code indicating success
      expected_exit_code: 0
      
      # Additional success indicators (any match = success)
      indicators:
        - "âœ“ Changes applied"
        - "Files updated successfully"
        - "Committed changes"
      
      # Failure indicators (any match = failure even if exit code 0)
      failure_indicators:
        - "ERROR:"
        - "FAILED:"
        - "Exception:"
        - "Traceback"
    
    # Resource limits
    resources:
      # Max memory usage (MB)
      max_memory: 2048
      
      # Max CPU percentage
      max_cpu: 80
      
      # Max open files
      max_files: 100
    
    # Logging configuration
    logging:
      # Log level: DEBUG, INFO, WARNING, ERROR
      level: "INFO"
      
      # Log file location
      file: "${worktree_path}/aider.log"
      
      # Rotate logs when they exceed size (MB)
      rotate_size: 10
      
      # Keep this many old log files
      rotate_count: 5

---
# ============================================================================
# SECTION 2: Advanced Tool Profiles
# ============================================================================
# More complex configurations for specialized use cases

  # Codex - OpenAI Codex API (for programmatic access)
  codex:
    name: "OpenAI Codex"
    type: "codex"
    
    # API-based tools use different command structure
    api:
      endpoint: "https://api.openai.com/v1/engines/code-davinci-002/completions"
      method: "POST"
      headers:
        Authorization: "Bearer ${OPENAI_API_KEY}"
        Content-Type: "application/json"
      
      # Request template (JSON)
      request_template: |
        {
          "prompt": "${task}",
          "max_tokens": 2000,
          "temperature": 0.2,
          "stop": ["###"]
        }
      
      # Response parsing
      response_parser:
        # JSONPath to extract generated code
        code_path: "$.choices[0].text"
        
        # JSONPath to extract usage stats
        usage_path: "$.usage"
    
    timeout:
      default: 120  # API calls typically faster
      
    retry:
      enabled: true
      max_attempts: 5  # APIs can be flaky
      strategy: "exponential"
      initial_delay: 2
      max_delay: 30
      
      # API-specific retry conditions
      retry_on:
        - "status_code: 429"  # Rate limit
        - "status_code: 503"  # Service unavailable
        - "status_code: 504"  # Gateway timeout
    
    circuit_breaker:
      enabled: true
      failure_threshold: 5  # Higher threshold for APIs
      window: 600  # 10-minute window
      cooldown: 120  # 2-minute cooldown

---
# ============================================================================
# SECTION 3: Tool Profile with Hooks
# ============================================================================
# Pre/post execution hooks for advanced automation

  aider_with_hooks:
    name: "Aider with Quality Checks"
    type: "aider"
    command: "aider"
    args: ["--yes", "--no-git", "--model", "gpt-4"]
    
    # Hooks execute at specific points in the lifecycle
    hooks:
      # Before tool execution
      pre_execute:
        - name: "Validate environment"
          command: "python"
          args: ["-m", "pip", "check"]
          continue_on_failure: false  # Fail if hook fails
        
        - name: "Check API key"
          command: "python"
          args: ["-c", "import os; exit(0 if os.getenv('OPENAI_API_KEY') else 1)"]
          continue_on_failure: false
      
      # After successful execution
      post_execute:
        - name: "Format code"
          command: "black"
          args: ["${files}"]
          continue_on_failure: true  # Don't fail on formatting errors
        
        - name: "Run type checker"
          command: "mypy"
          args: ["${files}"]
          continue_on_failure: true
        
        - name: "Run linter"
          command: "ruff"
          args: ["check", "${files}"]
          continue_on_failure: true
      
      # After failure
      on_failure:
        - name: "Collect debug info"
          command: "python"
          args: ["scripts/collect_debug_info.py", "${workstream_id}"]
          continue_on_failure: true
        
        - name: "Notify on failure"
          command: "python"
          args: ["scripts/notify.py", "--type", "failure", "--ws", "${workstream_id}"]
          continue_on_failure: true
      
      # Always run (success or failure)
      post_always:
        - name: "Cleanup temp files"
          command: "python"
          args: ["scripts/cleanup.py", "${worktree_path}"]
          continue_on_failure: true
    
    timeout:
      default: 900  # 15 minutes including hooks
      per_task: 300
      hooks_timeout: 120  # Max time for all hooks
    
    retry:
      enabled: true
      max_attempts: 3
      # Don't retry hooks on each attempt
      retry_hooks: false

---
# ============================================================================
# SECTION 4: Custom Tool Profile
# ============================================================================
# Template for custom AI tools not covered by built-in types

  custom_ai_tool:
    name: "Custom AI Assistant"
    type: "custom"
    
    # Custom adapter class (Python import path)
    adapter: "my_tools.adapters.CustomAIAdapter"
    
    # Custom adapter configuration
    adapter_config:
      model: "my-custom-model-v1"
      temperature: 0.3
      max_tokens: 4000
      custom_option: "value"
    
    # All standard options still apply
    command: "custom-ai"
    args: ["--interactive"]
    
    timeout:
      default: 300
    
    retry:
      enabled: true
      max_attempts: 2
    
    circuit_breaker:
      enabled: true
      failure_threshold: 3

---
# ============================================================================
# SECTION 5: Manual Tool Profile
# ============================================================================
# For human-in-the-loop or manual execution

  manual:
    name: "Manual Execution"
    type: "manual"
    
    # Prompt user for confirmation
    prompt:
      message: "Please complete the following tasks manually and confirm when done:"
      show_tasks: true
      show_files: true
      
      # Verification questions
      verification:
        - "Have all tasks been completed?"
        - "Have acceptance tests been run?"
        - "Are all files in the expected state?"
    
    # No timeout for manual execution
    timeout:
      default: null  # Infinite
    
    # Manual tools don't retry automatically
    retry:
      enabled: false
    
    circuit_breaker:
      enabled: false

---
# ============================================================================
# SECTION 6: Environment-Specific Overrides
# ============================================================================
# Different configurations for dev/staging/production

environments:
  # Development environment
  development:
    # Override tool profiles for dev
    tools:
      aider:
        # Shorter timeouts for fast feedback
        timeout:
          default: 300
        
        # More verbose logging
        logging:
          level: "DEBUG"
        
        # Faster model for dev
        args:
          - "--yes"
          - "--no-git"
          - "--model"
          - "gpt-3.5-turbo"  # Faster, cheaper model
  
  # CI/CD environment
  ci:
    tools:
      aider:
        # Longer timeouts for CI
        timeout:
          default: 1200
        
        # Disable interactive prompts
        args:
          - "--yes"
          - "--no-git"
          - "--model"
          - "gpt-4"
        
        # Stricter success criteria
        success:
          failure_indicators:
            - "ERROR:"
            - "FAILED:"
            - "Exception:"
            - "Warning:"  # Treat warnings as failures in CI
  
  # Production environment
  production:
    tools:
      aider:
        # Conservative settings for production
        timeout:
          default: 1800  # 30 minutes
        
        retry:
          max_attempts: 5  # More retries
          strategy: "exponential"
        
        circuit_breaker:
          failure_threshold: 2  # More sensitive
          cooldown: 300  # 5-minute cooldown
        
        # Best model for production quality
        args:
          - "--yes"
          - "--no-git"
          - "--model"
          - "gpt-4-turbo-preview"

---
# ============================================================================
# SECTION 7: Profile Inheritance
# ============================================================================
# Base profiles that can be extended

profile_templates:
  # Base template for AI tools
  base_ai_tool:
    timeout:
      default: 600
      per_task: 300
      grace_period: 30
    
    retry:
      enabled: true
      max_attempts: 3
      strategy: "exponential"
      initial_delay: 5
      max_delay: 60
    
    circuit_breaker:
      enabled: true
      failure_threshold: 3
      max_error_repeats: 2
      window: 300
      cooldown: 60
    
    logging:
      level: "INFO"
      rotate_size: 10
      rotate_count: 5
  
  # Extend base template
  extended_aider:
    extends: "base_ai_tool"  # Inherit from base
    
    # Override/add specific options
    name: "Extended Aider"
    type: "aider"
    command: "aider"
    args: ["--yes", "--no-git", "--model", "gpt-4"]
    
    # Additional timeout (merged with base)
    timeout:
      api_timeout: 60  # New option
    
    # Override retry settings
    retry:
      max_attempts: 5  # Override base value

---
# ============================================================================
# SECTION 8: Usage Examples
# ============================================================================
# How to reference these profiles in workstreams

# Example 1: Simple reference
# In workstream JSON:
# {
#   "tool": "aider"
# }

# Example 2: Environment-specific
# In workstream JSON:
# {
#   "tool": "aider",
#   "environment": "production"
# }

# Example 3: Override specific options
# In workstream JSON:
# {
#   "tool": "aider",
#   "tool_config": {
#     "timeout": {
#       "default": 1200
#     },
#     "args": ["--yes", "--no-git", "--model", "claude-3-opus"]
#   }
# }

# Example 4: Dynamic model selection
# In workstream JSON:
# {
#   "tool": "aider",
#   "tool_config": {
#     "args": [
#       "--yes",
#       "--no-git",
#       "--model",
#       "${env.AI_MODEL:-gpt-4}"
#     ]
#   }
# }

---
# ============================================================================
# END OF CONFIGURATION
# ============================================================================
# For more information, see:
# - docs/CONFIGURATION_GUIDE.md
# - docs/examples/02_parallel_execution.md
# - core/engine/tools.py (tool loader implementation)
