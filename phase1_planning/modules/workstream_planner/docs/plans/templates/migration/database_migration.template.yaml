# DATABASE MIGRATION TEMPLATE
# Pattern: Decision Elimination for Database Schema Changes
# DOC_ID: DOC-TEMPLATE-DB-MIGRATION-001

metadata:
  template_version: "1.0.0"
  pattern: EXEC-001
  purpose: eliminate_decisions_for_database_schema_changes
  decisions_eliminated: 4
  estimated_time_savings: 2_hours

parameters:
  migration_id:
    type: string
    required: true
    example: "uet_migration_001"

  tables_to_add:
    type: list
    required: true
    example:
      - name: uet_runs
        schema: "(run_id TEXT PRIMARY KEY, project_id TEXT, phase_id TEXT, state TEXT CHECK(state IN ('pending','running','completed','failed')))"
      - name: step_attempts
        schema: "(step_attempt_id TEXT PRIMARY KEY, run_id TEXT REFERENCES uet_runs(run_id), step_id TEXT, status TEXT)"

  rollback_sql_path:
    type: path
    required: true
    example: "schema/migrations/{migration_id}_rollback.sql"

  validation_query:
    type: string
    required: true
    example: "SELECT COUNT(*) FROM sqlite_master WHERE type='table'"

  success_criteria:
    type: dict
    required: true
    example:
      table_count_increased: 4
      foreign_keys_valid: true

ground_truth_gates:
  gate_1_import_works:
    command: "python -c \"from core.state.db_unified import dual_write_run\""
    expect_exit_code: 0
    failure_action: halt_and_report

  gate_2_migration_syntax_valid:
    command: "sqlite3 :memory: < schema/migrations/{migration_id}.sql"
    expect_exit_code: 0
    failure_action: halt_and_report

  gate_3_rollback_syntax_valid:
    command: "sqlite3 :memory: < {rollback_sql_path}"
    expect_exit_code: 0
    failure_action: halt_and_report

  gate_4_forward_migration_applies:
    command: |
      cp .worktrees/pipeline_state.db .worktrees/pipeline_state.db.backup
      sqlite3 .worktrees/pipeline_state.db < schema/migrations/{migration_id}.sql
      sqlite3 .worktrees/pipeline_state.db "{validation_query}"
    expect_table_count_increase: "{success_criteria.table_count_increased}"
    failure_action: restore_backup_and_halt

  gate_5_rollback_works:
    command: |
      sqlite3 .worktrees/pipeline_state.db < {rollback_sql_path}
      sqlite3 .worktrees/pipeline_state.db "{validation_query}"
    expect_table_count_equals_baseline: true
    failure_action: halt_and_report

execution_sequence:
  - step: create_migration_sql
    template: schema/migrations/{migration_id}.sql

  - step: create_rollback_sql
    template: {rollback_sql_path}

  - step: create_unified_db_bridge
    template: core/state/db_unified.py

  - step: run_ground_truth_gates
    gates: [gate_1, gate_2, gate_3, gate_4, gate_5]

  - step: create_tests
    template: tests/state/test_db_unified.py

anti_pattern_guards:
  hallucination_of_success:
    enabled: true
    rule: "Never mark migration complete without gate_4_forward_migration_applies passing"

  partial_success_amnesia:
    enabled: true
    rule: "Checkpoint after each gate passes; record in .execution/checkpoints.jsonl"

telemetry:
  track:
    - decisions_avoided
    - gates_passed
    - gates_failed
    - time_to_complete
    - rollback_invocations
  output: ".execution/telemetry.jsonl"
